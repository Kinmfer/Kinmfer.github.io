<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>网站服务-Nginx-基础 | Kinmfer's Blogs</title><meta name="keywords" content="网站服务,Nginx,I/O模型"><meta name="author" content="Kinmfer,kinmfer@foxmail.com"><meta name="copyright" content="Kinmfer"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="性能影响互联网存在用户速度体验的1-3-10原则，即1秒最优，3-10秒比较慢，10秒以上用户无法接受。用户放弃一个产品的代价很低，只是换一个URL而已。 影响用户体验的几个因素 客户端硬件配置 客户端网络速率 客户端与服务端距离 服务端网络速率 服务端硬件配置 服务端架构设计 服务端应用程序工作模式 服务端并发数量 服务端响应文件大小及数量 服务端I&#x2F;0压力  服务端I&#x2F;OI&#x2F;0在计算机中指In">
<meta property="og:type" content="article">
<meta property="og:title" content="网站服务-Nginx-基础">
<meta property="og:url" content="https://kinmfer.github.io/2020/05/26/%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84-Nginx-01-%E5%9F%BA%E7%A1%80/index.html">
<meta property="og:site_name" content="Kinmfer&#39;s Blogs">
<meta property="og:description" content="性能影响互联网存在用户速度体验的1-3-10原则，即1秒最优，3-10秒比较慢，10秒以上用户无法接受。用户放弃一个产品的代价很低，只是换一个URL而已。 影响用户体验的几个因素 客户端硬件配置 客户端网络速率 客户端与服务端距离 服务端网络速率 服务端硬件配置 服务端架构设计 服务端应用程序工作模式 服务端并发数量 服务端响应文件大小及数量 服务端I&#x2F;0压力  服务端I&#x2F;OI&#x2F;0在计算机中指In">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/Kinmfer/BlogImages/raw/master/img/nginx.png">
<meta property="article:published_time" content="2020-05-26T07:12:43.000Z">
<meta property="article:modified_time" content="2020-09-28T07:39:08.748Z">
<meta property="article:author" content="Kinmfer">
<meta property="article:tag" content="网站服务">
<meta property="article:tag" content="Nginx">
<meta property="article:tag" content="I&#x2F;O模型">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/Kinmfer/BlogImages/raw/master/img/nginx.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://kinmfer.github.io/2020/05/26/%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84-Nginx-01-%E5%9F%BA%E7%A1%80/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.js" defer></script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?c46ed77365f502de73543fbf10399875";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"C2N62A47W9","apiKey":"0c62f17095ec2a20c19657511a42c0b1","indexName":"Blogs","hits":{"per_page":6},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"这篇文章更新于","messageNext":"天前,内容可能已经过时"},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":200,"languages":{"author":"作者: Kinmfer","link":"链接: ","source":"来源: Kinmfer's Blogs","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"top-center"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}

// https://stackoverflow.com/questions/16839698/jquery-getscript-alternative-in-native-javascript
const getScript = url => new Promise((resolve, reject) => {
  const script = document.createElement('script')
  script.src = url
  script.async = true
  script.onerror = reject
  script.onload = script.onreadystatechange = function() {
    const loadState = this.readyState
    if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
    script.onload = script.onreadystatechange = null
    resolve()
  }
  document.head.appendChild(script)
})</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2020-09-28 15:39:08'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = '1  Following System Settings, if the system doesn't support dark mode, it will switch dark mode between 6 pm to 6 am'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="https://gitee.com/Kinmfer/BlogImages/raw/master/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">96</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">55</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">21</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://gitee.com/Kinmfer/BlogImages/raw/master/img/nginx.png)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Kinmfer's Blogs</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">网站服务-Nginx-基础</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-05-26T07:12:43.000Z" title="发表于 2020-05-26 15:12:43">2020-05-26</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2020-09-28T07:39:08.748Z" title="更新于 2020-09-28 15:39:08">2020-09-28</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/">综合架构</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/Nginx/">Nginx</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">21.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>77分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2020/05/26/%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84-Nginx-01-%E5%9F%BA%E7%A1%80/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2020/05/26/%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84-Nginx-01-%E5%9F%BA%E7%A1%80/" itemprop="commentCount"></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="性能影响"><a href="#性能影响" class="headerlink" title="性能影响"></a>性能影响</h1><p>互联网存在用户速度体验的1-3-10原则，即1秒最优，3-10秒比较慢，10秒以上用户无法接受。用户放弃一个产品的代价很低，只是换一个URL而已。</p>
<h2 id="影响用户体验的几个因素"><a href="#影响用户体验的几个因素" class="headerlink" title="影响用户体验的几个因素"></a>影响用户体验的几个因素</h2><ul>
<li>客户端硬件配置</li>
<li>客户端网络速率</li>
<li>客户端与服务端距离</li>
<li>服务端网络速率</li>
<li>服务端硬件配置</li>
<li>服务端架构设计</li>
<li>服务端应用程序工作模式</li>
<li>服务端并发数量</li>
<li>服务端响应文件大小及数量</li>
<li>服务端I/0压力</li>
</ul>
<h2 id="服务端I-O"><a href="#服务端I-O" class="headerlink" title="服务端I/O"></a>服务端I/O</h2><p>I/0在计算机中指Input/Output，IOPS (Input/Output Per Second)即每秒的输入输出量(或读写次数),是衡量磁盘性能的主要指标之一。IOPS是指的是在单位时间内系统能处理的I/O请求数量，一般以每秒处理的I/O请求数量为单位，I/0请求通常为读或写数据操作请求。</p>
<p>一次完整的I/O是用户空间的进程数据与内核空间的内核数据的报文的完整交换过程，但是由于内核空间与用户空间是严格隔离的，所以其数据交换过程中不能由用户空间的进程直接调用内核空间的内存数据，而是需要经历一次从内核空间中的内存数据copy到用户空间的进程内存当中，所以简单说一次I/O就是把数据从内核空间中的内存数据复制到用户空间中进程的内存当中的整个过程。<br>而网络通信就是从网络协议栈到用户空间进程的I/O,也就是网络I/O。</p>
<p><img src="https://gitee.com/Kinmfer/BlogImages/raw/master/img/image-20200522215643568.png" alt="image-20200522215643568"></p>
<p>磁盘I/O是进程向内核发起系统调用，请求磁盘上的某个资源比如是文件或者是图片，然后内核通过相应的驱动程序将目标图片加载到内核的内存空间，加载完成之后把数据从内核内存再复制给进程内存，如果是比较大的数据也需要等待时间。</p>
<p>每次I/O,都要经由两个阶段:<br>第一步:将数据从磁盘文件先加载至内核内存空间(缓冲区)， 此步骤需要等待数据准备完成，时间较长<br>第二步:将数据从内核缓冲区复制到用户空间的进程的内存中，时间较短</p>
<h1 id="I-O模型"><a href="#I-O模型" class="headerlink" title="I/O模型"></a>I/O模型</h1><h2 id="系统I-O"><a href="#系统I-O" class="headerlink" title="系统I/O"></a>系统I/O</h2><h3 id="同步-异步"><a href="#同步-异步" class="headerlink" title="同步/异步"></a>同步/异步</h3><p>关注的是事件处理的消息通信机制，即在等待一件事情的处理结果时，被调用者是否提供完成通知。</p>
<ul>
<li><p>同步: synchronous, 调用者等待被调用者返回消息后才能继续执行，如果被调用者不提供消息返回则为同步，同步需要调用者主动询问事情是否处理完成。</p>
<p>进程发出请求调用后，内核不提供通知机制，即文件I/O处理完成后不通知进程，需要进程自己去问内核是否处理完成。</p>
</li>
<li><p>异步: asynchronous, 被调用者通过状态、通知或回调机制主动通知调用者，即异步会主动返回被调用者的状态给调用者。</p>
<p>进程发出请求调用后，内核会在调用处理完成后返回调用结果给进程，Nginx是异步的。</p>
</li>
</ul>
<p><img src="https://gitee.com/Kinmfer/BlogImages/raw/master/img/image-20200522220129787.png" alt="image-20200522220129787"></p>
<h3 id="阻塞-非阻塞"><a href="#阻塞-非阻塞" class="headerlink" title="阻塞/非阻塞"></a>阻塞/非阻塞</h3><p>关注调用者在等待结果返回之前所处的状态</p>
<ul>
<li>阻塞: blocking,指I/O操作需要彻底完成后才返回到用户空间，调用结果返回之前，调用者被挂起，干不了别的事情。</li>
<li>非阻塞: nonblocking, 指I/O操作被调用后立即返回给用户一个状态值，无需等到I/O操作彻底完成，最终的调用结果返回之前，调用者不会被挂起，可以去做别的事情。</li>
</ul>
<p><img src="https://gitee.com/Kinmfer/BlogImages/raw/master/img/image-20200522220624181.png" alt="image-20200522220624181"></p>
<h3 id="系统IO模型组合"><a href="#系统IO模型组合" class="headerlink" title="系统IO模型组合"></a>系统IO模型组合</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">以我去吃饭为例:我点了10个包子</span><br><span class="line"></span><br><span class="line">同步与异步:</span><br><span class="line">我点包子之后厨师是否告诉我: </span><br><span class="line">	同步:厨师做好包子后会放到指定位置，但是做好包子之前需要自己一次次去看包子做好没有，厨师不会在包子做好之后通知我。</span><br><span class="line">	异步:厨师做好包子后告诉我包子做好放哪了。</span><br><span class="line">阻塞与非阻塞: </span><br><span class="line">我点包子后的状态:</span><br><span class="line">	阻塞:在厨师做包子期间一直在包子盘子前面等着，不能干别的事情。</span><br><span class="line">	非阻塞:点完包子就可以去干别的事情，比如去逛逛街或者买买买。</span><br><span class="line">	</span><br><span class="line">IO模型组合:</span><br><span class="line">同步阻塞:我点完包子后不能去做别的事情，而且不知道包子有没有做好，需要自己一直等着并一次次的问厨师做好没有。</span><br><span class="line">同步非阻塞:点完包子后可以去做别的事情，但是不能长时间做别的事情，因为我还是不知道包子有没有做好，也要自己一直等着并一次次的问厨师做好没有，只能抽空做点别的。</span><br><span class="line">异步阻塞:我点完包子后不能去做别的事情，但是厨师在做好包子后会告诉我，也就是我不用再一次次问厨师包子有没有做好了。</span><br><span class="line">异步非阻塞:我点完包子后可以做别的事情，而且可以一直在做别的去事情，因为厨师在做好包子后会告诉我。</span><br></pre></td></tr></table></figure>
<h2 id="网络I-O"><a href="#网络I-O" class="headerlink" title="网络I/O"></a>网络I/O</h2><p>阻塞型、非阻塞型、复用型、信号驱动型、异步</p>
<h3 id="同步阻塞型I-O-blocking-IO"><a href="#同步阻塞型I-O-blocking-IO" class="headerlink" title="同步阻塞型I/O(blocking IO)"></a>同步阻塞型I/O(blocking IO)</h3><p>阻塞I/O模型是最简单的I/O模型，用户线程在内核进行I/O操作时被阻塞</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">用户请求到达系统服务进程，然后进程通过系统调用read( )向内核发起IO读操作，即将用户请求由用户空间转到内核空间，内核接收到I&#x2F;O请求后开始从磁盘读取文件到内核内存，即在等用户请求的文件从磁盘到达内核内存后，然后将接收的数据拷贝到用户空间，然后完成read操作。</span><br><span class="line">用户请求需要等待内核将数据读取到进程内存后，处理用户的进程才可以继续处理该请求，整个I&#x2F;O请求的过程中，请求进程是被阻塞的，这导致进程在发起I&#x2F;O请求时，不能做任何事情，而且对CPU的资源利用率不够。</span><br></pre></td></tr></table></figure>
<p>优点:程序简单，在阻塞等待数据期间进程挂起，基本不会占用CPU资源<br>缺点:每个连接需要独立的进程单独处理，当并发请求量大时为了维护程序，内存、进程切换开销较大，apache的prefork使用的是这种模式。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">同步阻塞:程序向内核发送I&#x2F;O请求后一直等待内核响应，如果内核处理请求的I&#x2F;O操作不能立即返回，则进程将一直等待并不再接受新的请求，并由进程轮询查看I&#x2F;O是否完成，完成后进程将I&#x2F;O结果返回给Client,在I0没有返回期间进程不能接受其他客户的请求，而且是有进程自己去查看I&#x2F;O是否完成，这种方式简单，但是比较慢，用的比较少。</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/Kinmfer/BlogImages/raw/master/img/image-20200522221931653.png" alt="image-20200522221931653"></p>
<h3 id="同步非阻塞型I-O-nonblocking-IO"><a href="#同步非阻塞型I-O-nonblocking-IO" class="headerlink" title="同步非阻塞型I/O(nonblocking IO)"></a>同步非阻塞型I/O(nonblocking IO)</h3><p>用户请求进程向内核发起I/O请求时立即返回，但并未读取到任何数据，进程需要不断地发起I/O请求，直到数据到达进程空间的内存后，才真正读取到数据并继续执行，即前期需要一次次 “轮询”去查看请求是否数据是否准备报，但是此机制存在两个问题: 1.如果有大量文件描述符都要等，那么就得一个一个的read,这会带来大量的ContexSwitch (read是系统调用， 每调用一次就得在用户态和核心态切换一次) , 2.轮询的时间不好把握，这里是要猜多久之后数据才能到，等待时间设的太长，程序响应延迟就过大，但是设的太短，就会造成过于频繁的重试，干耗CPU而已，所以是比较浪费CPU的方式，因此一般很少直接使用这种模型，而是在其他IO模型中使用非阻塞I/O这一特性。</p>
<p><img src="https://gitee.com/Kinmfer/BlogImages/raw/master/img/image-20200522222319548.png" alt="image-20200522222319548"></p>
<h3 id="I-O多路复用型-IO-multiplexing"><a href="#I-O多路复用型-IO-multiplexing" class="headerlink" title="I/O多路复用型(IO multiplexing)"></a>I/O多路复用型(IO multiplexing)</h3><p>I/O multiplexing就是我们说的select, poll, epoll, 有些地方也称这种I/O方式为event driven I/O(事件驱动I/O),<br>select/poll/epoll的好处就在于单个process就可以同时处理多个网络连接的I/O。它的基本原理就是select, poll,epoll这个function会不断的轮询所负责的所有socket,当某个socket有数据到达了，就通知用户进程。<br>当用户进程调用了select,那么整个进程会被block,而同时，kernel会”监视”所有select负责的socket,当任何一个socket中的数据准备好了，select就会返回， 这个时候用户进程再调用read操作,将数据从kernel拷贝到用户进程。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Apache prefork是此模式的主进程+多进程&#x2F;单线程+select, work是主进程+多进程&#x2F;多线程+poll模式</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/Kinmfer/BlogImages/raw/master/img/image-20200523081231277.png" alt="image-20200523081231277"></p>
<h3 id="信号驱动式IO-signal-driven-IO"><a href="#信号驱动式IO-signal-driven-IO" class="headerlink" title="信号驱动式IO(signal-driven IO)"></a>信号驱动式IO(signal-driven IO)</h3><p>用户进程可以通过sigaction系统调用注册一个信号处理程序，然后进程可以继续向下执行，当有IO操作准备就绪时，由内核通知触发一个SIGIO信号处理程序执行，然后将用户进程所需要的数据从内核空间拷贝到用户空间，此模型的优势在于等待数据报到达期间进程不被阻塞，进程可以继续执行，只要等待来自信号处理函数的通知。</p>
<ul>
<li>优点:进程没有在等待数据时被阻塞，内核直接返回调用接收信号，不影响进程继续处理其他请求因此可以提高资源的利用率</li>
<li>缺点:信号IO在大量IO操作时可能会因为信号队列溢出导致没法通知</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">异步阻塞进程向内核发送IO调用后，不用等待内核响应，可以继续接受其他请求，内核收到进程请求后进行的IO如果不能立即返回，就由内核等待结果，直到IO完成后内核再通知进程，apache event模型就是主进程+多进程&#x2F;多线程+信号驱动</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/Kinmfer/BlogImages/raw/master/img/image-20200523081750981.png" alt="image-20200523081750981"></p>
<h3 id="异步非阻塞IO-asynchronous"><a href="#异步非阻塞IO-asynchronous" class="headerlink" title="异步非阻塞IO(asynchronous)"></a>异步非阻塞IO(asynchronous)</h3><p>相对于同步IO,异步IO不是顺序执行，用户进程进行aio_read系统调用之后，无论内核数据是否准备好，都会直接返回给用户进程，然后用户态进程可以去做别的事情，等到socket数据准备好了，内核直接复制数据给进程，然后从内核向进程发送通知，异步非阻塞IO的两个阶段，进程都是非阻塞的。<br>Linux提供了AIO库函数实现异步,但是用的很少，目前有很多开源的异步IO库，例如libevent、 libev、 libuv等,<br>异步过程如下图所示:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">异步非阻塞:程序进程向内核发送IO调用后，不用等待内核响应，可以继续接受其他请求，内核调用的IO如果不能立即返回，内核会继续处理其他事物，直到IO完成后将结果通知给内核，内核再将IO完成的结果返回给进程，期间进程可以接受新的请求，内核也可以处理新的事物，因此相互不影响，可以实现较大的同时并实现较高的IO复用，因此异步非阻塞使用最多的一种通信方式，nginx就是是异步非阻塞模型。</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/Kinmfer/BlogImages/raw/master/img/image-20200523082402713.png" alt="image-20200523082402713"></p>
<h3 id="IO对比"><a href="#IO对比" class="headerlink" title="IO对比"></a>IO对比</h3><p>这五种网络I/O模型中，越往后，阻塞越少，理论上效率也是最优前四种属于同步I/O,因为其中真正的I/O操作<br>(recvfrom)将阻塞进程/线程，只有异步I/O模型才与POSIX定义的异步I/O相匹配。</p>
<p><img src="https://gitee.com/Kinmfer/BlogImages/raw/master/img/image-20200524131352724.png" alt="image-20200524131352724"></p>
<h3 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h3><p>Nginx支持在多种不同的操作系统实现不同的事件驱动模型，但是其在不同的操作系统甚至是不同的系统版本上面的实现方式不尽相同，主要有以下实现方式:</p>
<p>1、select:<br>    select库是在linux和windows平台都基本支持的事件驱动模型库，并且在接口的定义也基本相同，只是部分参数的含义略有差异，最大井发限制1024,是最早期的事件驱动模型。<br>2、poll:<br>    在Linux的基本驱动模型，windows不支持此驱动模型，是select的升级版，取消了最大的并发限制，在编译nginx的时候可以使用–with-poll_ module和–without-poll_module这两个指定是否编译select库。<br>3、epoll:<br>    epoll库是Nginx服务器支持的最高性能的事件驱动库之一， 是公认的非常优秀的事件驱动模型，它和select和poll有很大的区别，epoll是poll的升级版， 但是与poll的效率有很大的区别.<br>epoll的处理方式是创建一个待处理的事件列表，然后把这个列表发给内核，返回的时候在去轮训检查这个表，以判断事件是否发生，epoll支持一个进程打开的最大事件描述符的上限是系统可以打开的文件的最大数，同时epoll库的IO效率不随描述符数目增加而线性下降，因为它只会对内核上报的“活跃”的描述符进行操作。<br>4、rtsig:<br>不是一个常用事件驱动，最大队列1024,不是很常用<br>5、kqueue:<br>用于支持BSD系列平台的高效事件驱动模型，主要用在FreeBSD 4. 1及以上版本、openBSD 2。0级以上版本，NetBSD级以上版本及Mac os x平台上，该模型也是poll库的变种，因此和epoll没有本质上的区别，都是通过避免轮训操作提供效率。<br>6、/dev/poll:<br>用于支持unix衍生平台的高效事件驱动模型，主要在Solaris平台、HP/UX， 该模型是sun公司在开发Solaris系列平台的时候提出的用于完成事件驱动机制的方案，它使用了虚拟的/dev/pol1设备，开发人员将要见识的文件描述符加入这个设备，然后通过ioctl( )调用来获取事件通知，因此运行在以上系列平台的时候请使用/ dev/poll事件驱动机制<br>7、eventport:<br>该方案也是sun公司在开发Solaris的时候提出的事件驱动库，只是Solaris 10以上的版本，该驱动库看防止内核崩溃等情况的发生。<br>8、Iocp:<br>Windows系统上的实现方式，对应第5种(异步I/0) 模型。</p>
<h3 id="常用模型汇总"><a href="#常用模型汇总" class="headerlink" title="常用模型汇总"></a>常用模型汇总</h3><table>
<thead>
<tr>
<th>\</th>
<th>select</th>
<th>poll</th>
<th>epoll</th>
</tr>
</thead>
<tbody><tr>
<td>操作方式</td>
<td>遍历</td>
<td>遍历</td>
<td>回调</td>
</tr>
<tr>
<td>底层实现</td>
<td>数组</td>
<td>链表</td>
<td>哈希表</td>
</tr>
<tr>
<td>IO效率</td>
<td>每次调用都进行线性遍历，时间复杂度为O(n)</td>
<td>每次调用都进行线性遍历，时间复杂度为O(n)</td>
<td>事件通知方式，每当fd就绪，系统注册的回调函数就会被调用，将就绪fd放到rdllist里面，时间复杂度为O(1)</td>
</tr>
<tr>
<td>最大连接数</td>
<td>1024(x86)或2048(x64)</td>
<td>无上限</td>
<td>无上限</td>
</tr>
<tr>
<td>fd拷贝</td>
<td>每次调用select，都需要把fd集合从用户态拷贝到内核态</td>
<td>每次调用select，都需要把fd集合从用户态拷贝到内核态</td>
<td>调用epoll_ctl时拷贝进内核并保存，之后每次epoll_wait不拷贝</td>
</tr>
</tbody></table>
<h3 id="常用模型通知对比"><a href="#常用模型通知对比" class="headerlink" title="常用模型通知对比"></a>常用模型通知对比</h3><ul>
<li>水平触发–多次通知，需要关心数据是否取完，即数据取走之后即不再通知进程，以避免重复多次无效通知，通知效率较低。</li>
<li>边缘触发–一次通知，需要关心数据是否取走，即只通知一次怎么保证数据被进程成功取走了，以避免数据丢失，通知效率较高。</li>
</ul>
<p><img src="https://gitee.com/Kinmfer/BlogImages/raw/master/img/image-20200523084013033.png" alt="image-20200523084013033"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">select:</span><br><span class="line">POSIX所规定，目前几乎在所有的平台上支持，其良好跨平台支持也是它的一个优点，本质上是通过设置或者检查存放fd标志位的数据结构来进行下一步处理</span><br><span class="line">缺点</span><br><span class="line">单个进程能够监视的文件描述符的数量存在最大限制，在Linux上一般为1024，可以通过修改宏定义FD_ SETSIZE, 再重新编译内核实现，但是这样也会造成效率的降低。</span><br><span class="line">单个进程可监视的fd数量被限制，默认是1024, 修改此值需要重新编译内核。</span><br><span class="line">对socket是线性扫描，即采用轮询的方法，效率较低。</span><br><span class="line">select采取了内存拷贝方法来实现内核将FD消息通知给用户空间，这样一个用来存放大量fd的数据结构， 这样会</span><br><span class="line">使得用户空间和内核空间在传递该结构时复制开销大。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">poll:</span><br><span class="line">本质上和select没有区别，它将用户传入的数组拷贝到内核空间，然后查询每个fd对应的设备状态。</span><br><span class="line">其没有最大连接数的限制，原因是它是基于链表来存储的。</span><br><span class="line">大量的fd的数组被整体复制于用户态和内核地址空间之间，而不管这样的复制是不是有意义。</span><br><span class="line">poll特点是&quot;水平触发”，如果报告了fd后，没有被处理，那么下次poll时会再次报告该fd。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">epoll:</span><br><span class="line">在Linux 2.6内核中提出的select和poll的增强版本。</span><br><span class="line">支持水平触发LT和边缘触发ET,最大的特点在于边缘触发，它只告诉进程哪些fd刚刚变为就绪态，并且只会通知一次</span><br><span class="line">使用“事件&quot;的就绪通知方式，通过epoll_ctl注册fd, 一旦该fd就绪，内核就会采用类似callback的回调机制来激活该fd, epoll_wait便可以收到通知。</span><br><span class="line">优点:</span><br><span class="line">没有最大并发连接的限制:能打开的FD的上限远大于1024(1G的内存能监听约10万个端口)，具体查看&#x2F;proc&#x2F;sys&#x2F;fs&#x2F;file-max,此值和系统内存大小相关</span><br><span class="line">效率提升:非轮询的方式，不会随着FD数目的增加而效率下降;只有活跃可用的FD才会调用callback函数，即epoll最大的优点就在于它只管理“活跃&quot;的连接，而跟连接总数无关</span><br><span class="line">内存拷贝，利用mmap(Memory Mapping)加速与内核空间的消息传递;即epoll使用mmap减少复制开销</span><br></pre></td></tr></table></figure>
<h3 id="MMAP介绍"><a href="#MMAP介绍" class="headerlink" title="MMAP介绍"></a>MMAP介绍</h3><p>mmap(memory mapping)系统调用使得进程之间通过映射同一个普通文件实现共享内存，普通文件被映射到进程地址空间后，进程可以像访问普通内存一样对文件进行访问。</p>
<h4 id="传统方式拷贝数据"><a href="#传统方式拷贝数据" class="headerlink" title="传统方式拷贝数据"></a>传统方式拷贝数据</h4><p><img src="https://gitee.com/Kinmfer/BlogImages/raw/master/img/image-20200523084715500.png" alt="image-20200523084715500"></p>
<h4 id="mmap方式"><a href="#mmap方式" class="headerlink" title="mmap方式"></a>mmap方式</h4><p><img src="https://gitee.com/Kinmfer/BlogImages/raw/master/img/image-20200523085054882.png" alt="image-20200523085054882"></p>
<h1 id="Nginx基础"><a href="#Nginx基础" class="headerlink" title="Nginx基础"></a>Nginx基础</h1><p>Nginx: engineX, 2002年开始开发，2004年开源，2019年3月11日， Nginx公司被E5 Networks以6.7亿美元收<br>购，Nginx官网: <a target="_blank" rel="noopener" href="http://nginx.org/">http://nginx.org</a>, Nginx商业版为Nginx Plus: <a target="_blank" rel="noopener" href="https://www.nginx.com/products/nginx/">https://www.nginx.com/products/nginx/</a><br>Nginx则是免费的、开源的、高性能的HTTP和反向代理服务器、邮件代理服务器、以及TCP/UDP代理 服务器<br>解决C10K问题(10K Connections) , <a target="_blank" rel="noopener" href="http://www.ideawu.net/blog/archives/740.html">http://www.ideawu.net/blog/archives/740.html</a><br>Nginx的其它的二次发行版:</p>
<ul>
<li>Tengine:由淘宝网发起的Web服务器项目。它在Nginx的基础上，针对大访问量网站的需求，添加了很多高级功能和特性，Tengine的性能和稳定性已经在大型的网站如淘宝网，天猫商城等得到了很好的检验，它的最终目标是打造一个高效、稳定、安全、易用的Web平台，从2011年12月开始，Tengine成为一个开源项目，官网<a target="_blank" rel="noopener" href="http://tengine.taobao.org/">http://tengine.taobao.org/</a></li>
<li>OpenResty:基于Nginx与Lua语言的高性能Web平台，章亦春团队开发，官网: <a target="_blank" rel="noopener" href="http://openresty.org/cn/">http://openresty.org/cn/</a></li>
</ul>
<h2 id="Nginx功能介绍"><a href="#Nginx功能介绍" class="headerlink" title="Nginx功能介绍"></a>Nginx功能介绍</h2><ul>
<li>静态的web资源服务器html,图片, js, css, txt等静态资源</li>
<li>结合FastCGI/uWSGI/SCGI等协议反向代理动态资源请求</li>
<li>http/https协议的反向代理</li>
<li>imap4/pop3协议的反向代理</li>
<li>tcp/udp协议的请求转发(反向代理)</li>
</ul>
<h3 id="基础特性"><a href="#基础特性" class="headerlink" title="基础特性"></a>基础特性</h3><ul>
<li>特性:<ul>
<li>模块化设计，较好的扩展性</li>
<li>高可靠性</li>
<li>支持热部署:不停机更新配置文件，升级版本，更换日志文件</li>
<li>低内存消耗: 10000个keep- alive连接模式下的非活动连接，仅需2. 5M内存</li>
<li>event - driven, aio, mmap, sendfile</li>
</ul>
</li>
<li>基本功能: <ul>
<li>静态资源的web服务器</li>
<li>http协议反向代理服务器</li>
<li>pop3/ imap4协议反向代理服务器</li>
<li>FastCGI(LNMP), UWSGI (python)等协议</li>
<li>模块化(非DSO) ，如zip, SSL模块</li>
</ul>
</li>
</ul>
<h3 id="和web相关的功能"><a href="#和web相关的功能" class="headerlink" title="和web相关的功能"></a>和web相关的功能</h3><ul>
<li>虚拟主机(server)</li>
<li>支持keep-alive和管道连接(利用一个连接做多次请求)</li>
<li>访问日志(支持基于日志缓冲提高其性能)</li>
<li>url rewirte</li>
<li>路径别名</li>
<li>基于IP及用户的访问控制</li>
<li>支持速率限制及并发数限制</li>
<li>重新配置和在线升级而无须中断客户的工作进程</li>
</ul>
<h2 id="Nginx组织结构"><a href="#Nginx组织结构" class="headerlink" title="Nginx组织结构"></a>Nginx组织结构</h2><p>web请求处理机制:</p>
<ol>
<li>多进程方式: 服务器每接收到一个客户端请求就有服务器的主进程生成一个子进程响应客户端，直到用户关闭连接，这样的优势是处理速度快，各子进程之间相互独立，但是如果访问过大会导致服务器资源耗尽而无法提供请求。</li>
<li>多线程方式: 与多进程方式类似，但是每收到一个客户端请求会有服务进程派生出一个线程来个客户方进行交互，一个线程的开销远远小于一个进程，因此多线程方式在很大程度减轻了web服务器对系统资源的要求，但是多线程也有自己的缺点，即当多个线程位于同一个进程内工作的时候，可以相互访问同样的内存地址空间，所以他们相互影响，另外一旦主进程挂掉则所有子线程都不能工作了，IIS服务器使用了多线程的方式，需要间隔一段时间就重启一次才能稳定。</li>
</ol>
<h3 id="组织模型"><a href="#组织模型" class="headerlink" title="组织模型"></a>组织模型</h3><p>Nginx是多进程组织模型，而且是一个由Master主进程和Worker工作进程组成。</p>
<p><img src="https://gitee.com/Kinmfer/BlogImages/raw/master/img/image-20200523100147356.png" alt="image-20200523100147356"></p>
<p>主进程(master process)的功能</p>
<ul>
<li>读取Nginx配置文件并验证其有效性和正确性</li>
<li>建立、绑定和关闭socket连接</li>
<li>按照配置生成、管理和结束工作进程</li>
<li>接受外界指令，比如重启、升级及退出服务器等指令</li>
<li>不中断服务，实现平滑升级，重启服务并应用新的配置</li>
<li>开启日志文件，获取文件描述符</li>
<li>不中断服务，实现平滑升级，升级失败进行回滚处理</li>
<li>编译和处理perl脚本</li>
</ul>
<p>工作进程(work process)的功能</p>
<ul>
<li><p>接受处理客户的请求</p>
</li>
<li><p>将请求以此送入各个功能模块进行处理</p>
</li>
<li><p>IO调用，获取相应数据</p>
</li>
<li><p>与后端服务器通信，接收后端服务器的处理结果</p>
</li>
<li><p>缓存数据，访问缓存索引，查询和调用缓存数据</p>
</li>
<li><p>发送请求结果，响应客户的请求</p>
</li>
<li><p>接收主程序指令，比如重启、升级和退出等</p>
<p><img src="https://gitee.com/Kinmfer/BlogImages/raw/master/img/image-20200524132819924.png" alt="image-20200524132819924"></p>
</li>
</ul>
<h3 id="进程间通信"><a href="#进程间通信" class="headerlink" title="进程间通信"></a>进程间通信</h3><p>工作进程是有主进程生成的，主进程使用fork()函数，在Nginx服务器启动过程中主进程根据配置文件决定启动工作进程的数量，然后建立一张全局的工作表用于存放当前未退出的所有的工作进程，主进程生成工作进程后会将新生成的工作进程加入到工作进程表中，并建立一个单向的管道并将其传递给工作进程，该管道与普通的管道不同，它是由主进程指向工作进程的单向通道，包含了主进程向工作进程发出的指令、工作进程ID、工作进程在工作进程表中的索引和必要的文件描述符等信息。</p>
<p>主进程与外界通过信号机制进行通信，当接收到需要处理的信号时，它通过管道向相关的工作进程发送正确的指令，每个工作进程都有能力捕获管道中的可读事件，当管道中有可读事件的时候，工作进程就会从管道中读取并解析指令，然后采取相应的执行动作，这样就完成了主进程与工作进程的交互。</p>
<p>工作进程之间的通信原理基本上和主进程与工作进程之间的通信是一样的，只要工作进程之间能够取得彼此的信息，建立管道即可通信，但是由于工作进程之间是完全隔离的，因此一个进程想要知道另外一个进程的状态信息就只能通过主进程来设置了。为了实现工作进程之间的交互，主进程在生成工作进程之后，在工作进程表中进行遍历，将该新进程的ID以及针对该进程建立的管道句柄传递给工作进程中的其他进程，为工作进程之间的通信做准备，当工作进程1向工作进程2发送指令的时候，首先在主进程给它的其他工作进程工作信息中找到2的进程ID,然后将正确的指令写入指向进程2的管道，工作进程2捕获到管道中的事件后，解析指令并进行相关操作，这样就完成了工作进程之间的通信。</p>
<p><img src="https://gitee.com/Kinmfer/BlogImages/raw/master/img/image-20200523102552854.png" alt="image-20200523102552854"></p>
<h2 id="Nginx模块介绍"><a href="#Nginx模块介绍" class="headerlink" title="Nginx模块介绍"></a>Nginx模块介绍</h2><ul>
<li>核心模块:是Nginx服务器正常运行必不可少的模块，提供错误日志记录、配置文件解析、事件驱动机制、<br>进程管理等核心功能</li>
<li>标准HTTP模块:提供HTTP协议解析相关的功能，比如:端口配置、网页编码设置、HTTP响应头设置等等</li>
<li>可选HTTP模块:主要用于扩展标准的HTTP功能，让Nginx能处理一些特殊的服务， 比如: Flash 多媒体传输、解析GeolP请求、网络传输压缩、安全协议SSL支持等</li>
<li>邮件服务模块:主要用于支持Nginx的邮件服务，包括对POP3协议、IMAP 协议和SMTP协议的支持</li>
<li>第三方模块:是为了扩展Nginx服务器应用，完成开发者自定义功能，比如: Json 支持、Lua 支持等</li>
</ul>
<p>nginx高度模块化，但其模块早期不支持DSO机制; 1.9.11版本支持动态装载和卸载</p>
<p><img src="https://gitee.com/Kinmfer/BlogImages/raw/master/img/image-20200523103805394.png" alt="image-20200523103805394"></p>
<h2 id="Nginx安装"><a href="#Nginx安装" class="headerlink" title="Nginx安装"></a>Nginx安装</h2><p>Nginx的安装版本分为Mainline version(主要开发放本，其实就是还处于开友版)。Stable version(当前最新稳定版)和Legacy versions(旧的稳定版)，Nginx安装可以使用yum或源码安装，但是推荐使用源码，一是yum的版本比较旧，二是编译安装可以更方便自定义相关路径，三是使用源码编译可以自定义相关功能，更方便业务的上的使用，源码安装需要提前准备标准的编译器，GCC的全称是(GNU Compiler collection)，其有GNU开发，并以GPL即LGPL许可，是自由的类UNIX即苹果电脑Mac OS X操作系统的标准编译器，因为GCC原本只能处理C语言,所以原名为GNU C语言编译器，后来得到快速发展，可以处理C++,Fortran, pascal, objective-C, java以及Ada等其他语言，此外还需要Automake工具，以完成自动创建Makefile的工作，Nginx的一 些模块需要依赖第三方库,比如pcre (支持rewrite) , zlib (支持gzip模块) 和openssI (支持ssl模块)等。</p>
<h3 id="Nginx-yum安装"><a href="#Nginx-yum安装" class="headerlink" title="Nginx yum安装"></a>Nginx yum安装</h3><p>Install the prerequisites:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install yum-utils</span><br></pre></td></tr></table></figure>
<p>To set up the yum repository, create the file named <code>/etc/yum.repos.d/nginx.repo</code> with the following contents:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[nginx-stable]</span><br><span class="line">name=nginx stable repo</span><br><span class="line">baseurl=http://nginx.org/packages/centos/<span class="variable">$releasever</span>/<span class="variable">$basearch</span>/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line">module_hotfixes=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">[nginx-mainline]</span><br><span class="line">name=nginx mainline repo</span><br><span class="line">baseurl=http://nginx.org/packages/mainline/centos/<span class="variable">$releasever</span>/<span class="variable">$basearch</span>/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line">module_hotfixes=<span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>By default, the repository for stable nginx packages is used. If you would like to use mainline nginx packages, run the following command:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum-config-manager --<span class="built_in">enable</span> nginx-mainline</span><br></pre></td></tr></table></figure>
<p>To install nginx, run the following command:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install nginx</span><br></pre></td></tr></table></figure>
<p>When prompted to accept the GPG key, verify that the fingerprint matches <code>573B FD6B 3D8F BC64 1079 A6AB ABF5 BD82 7BD9 BF62</code>, and if so, accept it.</p>
<h3 id="Nginx编译安装"><a href="#Nginx编译安装" class="headerlink" title="Nginx编译安装"></a>Nginx编译安装</h3><p>下载源码包<a target="_blank" rel="noopener" href="http://nginx.org/en/download.html">http://nginx.org/en/download.html</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@s2 -]<span class="comment"># cd /usr/local/src/</span></span><br><span class="line">[root@s2 src]<span class="comment"># wget https://nginx.org/download/nginx-1.18.1.tar.gz</span></span><br><span class="line">[root@s2 src]<span class="comment"># tar xf nginx-1.18.1.tar.gz</span></span><br><span class="line">[root@s2 src]<span class="comment"># cd nginx-1.18.1/</span></span><br><span class="line">编译是为了检查系统环境是否符合编译安装的要求，比如是否有gcc编译工具，是否支持编译参数当中的模块，并根据</span><br><span class="line">开启的参数等生成Makefile文件为下一一步做准备: </span><br><span class="line">[root@s2 nginx-1.18.1]<span class="comment"># . /configure --prefix=/apps/nginx \</span></span><br><span class="line">--user=nginx \</span><br><span class="line">--group=nginx \</span><br><span class="line">--with-http_ssl_module \</span><br><span class="line">--with-http_V2_module \</span><br><span class="line">--with-http_realip_module \</span><br><span class="line">--with-http_stub_status_module \</span><br><span class="line">--with-http_gzip_static_module \</span><br><span class="line">--with-pcre\</span><br><span class="line">--with-stream\</span><br><span class="line">--with-stream_ssl_module\</span><br><span class="line">--with-stream_realip_module</span><br><span class="line">[root@s2 nginx-1.18.1]<span class="comment"># make #编译步骤， 根据Makefile文件生成相应的模块</span></span><br><span class="line">[root@s2 nginx-1.18.1]<span class="comment"># make install #创建目录，并将生成的模块和文件复制到相应的目录:</span></span><br><span class="line">[root@s2 nginx-1.18.1]<span class="comment"># useradd nginx -s /sbin/nologin -u 2000 #以普通用户启动nginx</span></span><br><span class="line">[root@s2 nginx-1.18.1]<span class="comment"># chown nginx.nginx -R /apps/nginx/</span></span><br></pre></td></tr></table></figure>
<p>备注: nginx完成安装以后，有四个主要的目录:</p>
<ul>
<li>conf:该目录中保存了nginx所有的配置文件，其中nginx.conf是nginx服务器的最核心最主要的配置文件，其他的.conf则是用来配置nginx相关的功能的，例如fastcgi功能使用的是fastcgi.conf和fastcgi_params两个文件，配置文件一般都有个样板配置文件，是文件名.default结尾，使用的使用将其复制为并将default去掉即可。</li>
<li>html:该目录中保存了nginx服务器的web文件，但是可以更改为其他目录保存web文件，另外还有一个50x的web文件是默认的错误页面提示页面。</li>
<li>logs:该目录用来保存nginx服务器的访问日志错误日志等日志，logs目录可以放在其他路径，比<br>如/var/logs/nginx里面。</li>
<li>sbin:该目录用来保存nginx二进制启动脚本，可以接受不同的参数以实现不同的功能。</li>
</ul>
<p>验证版本及编译参数</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@s2 nginx-1.16.1]<span class="comment"># /apps/nginx/sbin/nginx -V</span></span><br><span class="line">nginx version: nginx/1.16.1</span><br><span class="line">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-39) (GCC)</span><br><span class="line">built with openSSL 1.0.2k-fips 26 Jan 2017</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix=/apps/nginx --user=nginx --group=nginx --with-</span><br><span class="line">http_ssl_module --with-http_v2_module --with-http_realip_module --with-</span><br><span class="line">http_stub_status module --with-http_gzip_static_module --with-pcre --with-streamwith-stream_ssl_module --with-stream_realip_module</span><br></pre></td></tr></table></figure>
<p>创建Nginx自启动脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@s1 ~]<span class="comment"># cat /usr/lib/systemd/system/nginx.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=The nginx HTTP and reverse proxy server</span><br><span class="line">After=network.target remote-fs.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">PIDFile=/run/nginx.pid</span><br><span class="line"><span class="comment"># Nginx will fail to start if /run/nginx.pid already exists but has the wr ong</span></span><br><span class="line"><span class="comment"># SELinux context. This might happen when running &quot;nginx -t” from the cmdline.</span></span><br><span class="line"><span class="comment"># https ://bugzilla. redhat com/ show_bug.cgi?id=1268621</span></span><br><span class="line">ExecstartPre=/usr/bin/rm -f /run/nginx. pid</span><br><span class="line">ExecStartPre=/apps/nginx/sbin/nginx -t</span><br><span class="line">ExecStart=/apps/nginx/sbin/nginx</span><br><span class="line">ExecReload=/bin/<span class="built_in">kill</span> -S HUP <span class="variable">$MAINPID</span></span><br><span class="line">Killsignal=SIGQUIT</span><br><span class="line">TimeoutStopSec=5</span><br><span class="line">KillMode=process</span><br><span class="line">PrivateTmp=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<h1 id="Nginx核心配置详解"><a href="#Nginx核心配置详解" class="headerlink" title="Nginx核心配置详解"></a>Nginx核心配置详解</h1><h2 id="默认配置文件"><a href="#默认配置文件" class="headerlink" title="默认配置文件"></a>默认配置文件</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@s2 -]<span class="comment"># grep -V &quot;#” /apps/nginx/conf/nginx.conf I grep -V &quot;A$&quot;</span></span><br><span class="line"><span class="comment">#全局配置端，对全局生效，主要设置nginx的启动用户/组，启动的工作进程数量，工作模式，Nginx的PID路径， 日志路径等。</span></span><br><span class="line">user nginx nginx;</span><br><span class="line">worker_processes 1; <span class="comment">#启动工作进程数数量</span></span><br><span class="line">events &#123; <span class="comment">#events设置快， 主要影响nginx服务器与用户的网络连接，比如是否允许同时接受多个网络连接，使用哪种事件驱动模型处理请求，每个工作进程可以同时支持的最大连接数，是否开启对多工作进程下的网络连接进行序列化等。</span></span><br><span class="line">	worker_connections 1024;<span class="comment">#设置单个nginx工作进程可以接受的最大并发，作为web服务器的时候最大并发数为worker_connections * worker_processes, 作为反向代理的时候为(worker_connections *worker_processes)/2</span></span><br><span class="line">http &#123; <span class="comment">#http块是Nginx服务器配置中的重要部分，缓存、代理和日志格式定义等绝大多数功能和第三方模块都可以在这设置，http块可以包含多个server块，而一个server块中又可以包含多个location块，server 块可以配置文件引入、MIME-Type定义、日志自定义、是否启sendfile、连接超时时间和单个链接的请求上限等。</span></span><br><span class="line">	include mime.types;</span><br><span class="line">	default_type application/octet-stream;</span><br><span class="line">	sendfile on; <span class="comment">#作为web服务器的时候打开sendfile加快静态文件传输，指定是否使用sendfile系统调用来传输文件，sendfile系统调用在两个文件描述符之间直接传递数据(完全在内核中操作)，从而避免了数据在内核缓冲区和用户缓冲区之间的拷贝，操作效率很高，被称之为零拷贝，硬盘 &gt;&gt; kernel buffer (快速拷贝到kernelsocket buffer) &gt;&gt;协议栈。</span></span><br><span class="line">	keepalive_ timeout 65; <span class="comment">#长连接超时时间， 单位是秒</span></span><br><span class="line">	server &#123; <span class="comment">#设置-个虚拟机主机，可以包含自己的全局快，同时也可以包含多个location模块。比如本虚拟机监听的端口、本虚拟机的名称和IP配置，多个server 可以使用一 个端口，比如都使用80端口提供web服务</span></span><br><span class="line">	listen 80; <span class="comment">#配置server 监听的端口</span></span><br><span class="line">	server_name localhost; <span class="comment">#本server的名称，当访问此名称的时候nginx 会调用当前serevr内部的配置进程匹配。</span></span><br><span class="line">	location / &#123; <span class="comment">#location其实是server的一个指令,为nginx服务 器提供比较多而且灵活的指令，都是在location中提现的，主要是基于nginx接受到的请求字符串，对用户请求的UIL进行匹配，并对特定的指令进行处理，包括地址重定向、数据缓存和应答控制等功能都是在这部分实现，另外很多第三方模块的配置也是在location模块中配置。</span></span><br><span class="line">		root html; <span class="comment">#相当于默认页面的目录名称，默认是相对路径，可以使用绝对路径配置。</span></span><br><span class="line">		index index.html index.htm; <span class="comment">#默认的页面文件名称</span></span><br><span class="line">	&#125;</span><br><span class="line">	error_ page 500 502 503 504 /50x.html; <span class="comment">#错误页面的文件名称</span></span><br></pre></td></tr></table></figure>
<h2 id="全局配置"><a href="#全局配置" class="headerlink" title="全局配置"></a>全局配置</h2><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">user</span> nginx nginx; <span class="comment">#启动Nginx工作进程的用户和组</span></span><br><span class="line"><span class="attribute">worker_processes</span> [number| auto]; <span class="comment">#启动Nginx工作进程的数量</span></span><br><span class="line"><span class="attribute">worker_cpu_affinity</span> [<span class="number">0000001</span> <span class="number">0000010</span> <span class="number">0000100</span> <span class="number">00001000</span> | auto ]; <span class="comment">#将Nginx工作进程绑定到指定的CPU核心，默认Nginx是不进行进程绑定的，绑定并不是意味着当前nginx进程独占以一核心CPU,但是可以保证此进程不会运行在其他核心上，这就极大减少了nginx的工作进程在不同的cpu核心上的来回跳转，减少了CPU对进程的资源分配与回收以及内存管理等，因此可以有效的提升nginx服务器的性能。</span></span><br><span class="line">[root@s2 ~]#ps axo pid, cmd, psr,user | grep nginx</span><br><span class="line">4106 nginx: master process / apps  1 root</span><br><span class="line">4181 nginx: worker process         θ nginx</span><br><span class="line">4182 nginx: worker process         1 nginx</span><br><span class="line">4184 grep --color-auto nginx       θ root</span><br><span class="line"><span class="comment">#错误日志记录配置，语法: error log file [debug | info | notice| warn | error| crit |alert | emerg ]</span></span><br><span class="line"><span class="comment">#error_log   logs/error.log;</span></span><br><span class="line"><span class="comment">#error_log   logs/error.log notice;</span></span><br><span class="line"><span class="attribute">error_log</span>     /apps/nginx/1ogs/error.log <span class="literal">error</span>;</span><br><span class="line"><span class="comment">#pid文件保存路径</span></span><br><span class="line"><span class="attribute">pid</span>          /apps/nginx/logs/nginx.pid; </span><br><span class="line"><span class="attribute">worker_priority</span> <span class="number">0</span>; <span class="comment">#工作进程nice值， -20到+19</span></span><br><span class="line"><span class="attribute">worker_rlimit_nofile</span> <span class="number">65536</span>; <span class="comment">#这个数字包括Nginx的所有连接(例如与代理服务器的连接等)，而不仅仅是与客户端的连接，另一个考虑因素是实际的并发连接数不能超过系统级别的最大打开文件数的限制，</span></span><br><span class="line">[root@s2 ~]# watch -n1 &#x27;ps -axo pid, cmd,nice I grep nginx&#x27; #验证进程优先级</span><br><span class="line"></span><br><span class="line"><span class="attribute">daemon</span> <span class="literal">off</span>; <span class="comment">#前台运行Nginx服务用于测试、 docker等环境。</span></span><br><span class="line"><span class="attribute">master_process</span> <span class="literal">off</span>|<span class="literal">on</span>; <span class="comment">#是否开启Nginx的master-woker工作模式，仅用于开发调试场景。</span></span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123; <span class="comment">#事件模型配置参数</span></span><br><span class="line">	<span class="attribute">worker_connections</span> <span class="number">65536</span>; <span class="comment">#设置 单个工作进程的最大并发连接数</span></span><br><span class="line">	<span class="attribute">use</span> <span class="literal">epoll</span>; <span class="comment">#使用epoll事件驱动， Nginx支持众多的事件驱动，比如select、poll、 epoll, 只能设置在events模块中设置。</span></span><br><span class="line">	<span class="attribute">accept_mutex</span> <span class="literal">on</span>; <span class="comment">#优化同一时刻只有一个请求而避免多个睡眠进程被唤醒的设置，on为防止被同时唤醒，默认为off,全部唤醒的过程也成为&quot;惊群”，因此nginx刚安装完以后要进行适当的优化。</span></span><br><span class="line">	<span class="attribute">multi_accept</span> <span class="literal">on</span>; <span class="comment">#Nginx服务器的每个工作进程可以同时接受多个新的网络连接，但是需要在配置文件中配置，此指令默认为关闭，即默认为一个工作进程只能一次接受一个新的网络连接， 打开后几个同时接受多个。</span></span><br></pre></td></tr></table></figure>
<h2 id="http详细配置"><a href="#http详细配置" class="headerlink" title="http详细配置"></a>http详细配置</h2><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">	<span class="attribute">include</span> 	 mime .types; <span class="comment">#导入支持的文件类型</span></span><br><span class="line">	<span class="attribute">default_type</span> application/octet-stream; <span class="comment">#设置默认的类型，会提示下载不匹配的类型文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#日志配置部分</span></span><br><span class="line">	<span class="comment">#log_format main &#x27;$remote.addr.$remote_user [$time_1ocal] &quot;Srequest&quot;</span></span><br><span class="line">	<span class="comment">#&#x27;$status $body_bytes_sent </span></span><br><span class="line">    <span class="comment">#&quot;$http_referer&quot;</span></span><br><span class="line">	<span class="comment">#&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span></span><br><span class="line">	<span class="comment">#access_1og logs/access.1og main;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">#自定义优化参数</span></span><br><span class="line"><span class="attribute">sendfile</span> 	<span class="literal">on</span>; <span class="comment">#实现文件零拷贝</span></span><br><span class="line"><span class="comment">#tcp_nopush on; #在开启了 sendfile的情况下，合并请求后统一发送给客户端。</span></span><br><span class="line"><span class="comment">#tcp_nodelay off; #在开启了keepalived模式下的连接是否启用TCP. NODELAY选项，当为off时，延迟0.2s发送，默认on时，不延迟发送，立即发送用户相应报文。</span></span><br><span class="line"><span class="attribute">keepalive_timeout</span> <span class="number">65</span>; <span class="comment">#设置会话保持时间</span></span><br><span class="line"><span class="comment">#gzip on; 开启文件压缩</span></span><br><span class="line">	<span class="section">server</span> &#123;</span><br><span class="line">		<span class="attribute">listen</span> <span class="number">80</span>; <span class="comment">#设置监听地址和端口</span></span><br><span class="line">		<span class="attribute">server_name</span> localhost; <span class="comment">#设置server name, 可以以空格隔开写多个并支持正则表达式，如*.kinmfer.com  www.kinmfer.* www.(site\d+)\.kinmfer\.com$ default_server</span></span><br><span class="line">        <span class="comment">#匹配机制:</span></span><br><span class="line">		<span class="comment">#(1)首先是字符串精确匹配;</span></span><br><span class="line">		<span class="comment">#(2)左侧*通配符;</span></span><br><span class="line">		<span class="comment">#(3)右侧*通配符;</span></span><br><span class="line">		<span class="comment">#(4)正则表达式;</span></span><br><span class="line">        </span><br><span class="line">		<span class="comment">#charset koi8-r; #设置编码格式，默认是俄语格式，可以改为utf-8</span></span><br><span class="line">		<span class="comment">#access_log logs/host.access.log main;</span></span><br><span class="line">		<span class="attribute">location</span> / &#123;</span><br><span class="line">			<span class="attribute">root</span>  html;</span><br><span class="line">			<span class="attribute">index</span> index.html index.htm;</span><br><span class="line">            </span><br><span class="line">       <span class="comment">#location ~ \.php$ &#123; #以fastcgi的方式转发php请求到php处理</span></span><br><span class="line">       <span class="comment">#root html;</span></span><br><span class="line">	   <span class="comment">#fastcgi_ pass  127.0.0.1:9000;</span></span><br><span class="line">	   <span class="comment">#fastcgi_index index.php;</span></span><br><span class="line">	   <span class="comment">#fastcgi param SCRIPT_ FILENAME /scripts$fastcgi script_ name;</span></span><br><span class="line">	   <span class="comment">#include fastcgi_params;</span></span><br><span class="line">	   <span class="comment">#&#125;</span></span><br><span class="line">	   <span class="comment"># deny access to .htaccess files, if Apache&#x27;s document root</span></span><br><span class="line">       <span class="comment"># concurs with nginx&#x27;s one</span></span><br><span class="line">	   <span class="comment">#</span></span><br><span class="line">	   <span class="comment">#location ~ /\.ht &#123; #拒绝web形式访问指定文件，如很多的网站都是通过. htaccess文件来改变自己的重定向等功能。</span></span><br><span class="line">	   <span class="comment">#  deny all; </span></span><br><span class="line">       <span class="comment">#&#125;</span></span><br><span class="line">       <span class="attribute">location</span> <span class="regexp">~ /passwd.html</span> &#123;</span><br><span class="line">	   		<span class="attribute">deny</span> all; </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	   <span class="comment"># HTTPS server</span></span><br><span class="line">	   <span class="comment">#</span></span><br><span class="line">       <span class="comment">#server &#123; #https服务器配置</span></span><br><span class="line">       <span class="comment"># listen  443 ssl;</span></span><br><span class="line">       <span class="comment"># server_name localhost;</span></span><br><span class="line">       <span class="comment"># ssl_ certificate cert.pem;</span></span><br><span class="line">	   <span class="comment"># ssl_certificate_key cert.key;</span></span><br><span class="line">	   <span class="comment"># ssl_session_cache shared:SSL:1m;</span></span><br><span class="line">	   <span class="comment"># ssl_session_timeout 5m;</span></span><br><span class="line">	   <span class="comment"># ssl_ciphers HIGH: !aNULL: !MD5;</span></span><br><span class="line">	   <span class="comment"># ssl_prefer_server.ciphers on;</span></span><br><span class="line">       <span class="comment"># location / &#123;</span></span><br><span class="line">			<span class="comment">#root html;</span></span><br><span class="line">			<span class="comment">#index index.html index.htm;</span></span><br><span class="line">	   <span class="comment">#&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="核心配置示例"><a href="#核心配置示例" class="headerlink" title="核心配置示例"></a>核心配置示例</h2><h3 id="root和alias"><a href="#root和alias" class="headerlink" title="root和alias"></a>root和alias</h3><p>root:指定web的家目录，在定义location的时候，文件的绝对路径等于root+location,如:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">	<span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">	<span class="attribute">server_name</span> www.kinmfer.com</span><br><span class="line">	location / &#123;</span><br><span class="line">		<span class="attribute">root</span> /data/nginx/html/pc ;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="attribute">location</span> /about &#123;</span><br><span class="line">		<span class="attribute">root</span> /data/nginx/html/pc; <span class="comment">#必须要在html目录中创建一个about目录才可以访问，否则报错。</span></span><br><span class="line">		<span class="attribute">index</span> index.html;</span><br><span class="line">	&#125;</span><br><span class="line">[root@s2 ~]# mkdir /data/nginx/html/pc/about</span><br><span class="line">[root@s2 ~]# echo about &gt; /data/nginx/html/pc/about/index.html</span><br><span class="line">重启Nginx并访问测试</span><br></pre></td></tr></table></figure>
<p>alias:定义路径别名，会把访问的路径重新定义到其指定的路径，如：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">	<span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">	<span class="attribute">server_name</span> www.kinmfer.com;</span><br><span class="line">	<span class="attribute">location</span> /about &#123; <span class="comment">#使用alias的时候uri后面如果加了斜杠则下面的路径配置必须加斜杠，否则403</span></span><br><span class="line">		<span class="attribute">alias</span> /data/nginx/html/pc; <span class="comment">#当访问about的时候， 会显示alias定义的/data/nginx/html/pc 里面的内容。</span></span><br><span class="line">		<span class="attribute">index</span> index .html;</span><br><span class="line">	&#125;</span><br><span class="line">重启Nginx并访问测试</span><br><span class="line">http://www.kinmfer.com/about/index.html #访问指定文件资源</span><br></pre></td></tr></table></figure>
<h3 id="location的详细使用"><a href="#location的详细使用" class="headerlink" title="location的详细使用"></a>location的详细使用</h3><p>在没有使用正则表达式的时候，nginx会先在server中的多个location选取匹配度最高的一个uri, uri是用户请求的字符串，即域名后面的web文件路径，然后使用该location模块中的正则uri和字符串，如果匹配成功就结束搜索，并使用此location处理此请求。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">语法规则: location [=|~|~*|^~] /uri/ &#123; ... &#125;</span><br><span class="line">= 	<span class="comment">#用于标准uri前，需要请求字串与uri精确匹配，如果匹配成功就停止向下匹配并立即处理请求。</span></span><br><span class="line">~   <span class="comment">#用于标准uri前，表示包含正则表达式井且区分大小写，并且匹配</span></span><br><span class="line">!~  <span class="comment">#用于标准uri前， 表示包含正则表达式并且区分大小写，并且不匹配</span></span><br><span class="line"></span><br><span class="line">~*  <span class="comment">#用于标准uri前， 表示包含正则表达式并且不区分大写，并且匹配</span></span><br><span class="line">!~* <span class="comment">#用于标准uri前，表示包含正则表达式并且不区分大小写,并且不匹配</span></span><br><span class="line">^~  <span class="comment">#用于标准uri前， 表示包含正则表达式并且匹配以什么开头</span></span><br><span class="line">$   <span class="comment">#用于标准uri前， 表示包含正则表达式并且匹配以什么结尾</span></span><br><span class="line">\   <span class="comment">#用于标准uri前， 表示包含正则表达式并且转义字符。可以转. * ?等</span></span><br><span class="line">*   <span class="comment">#用于标准uri前，表示包含正则表达式并且代表任意长度的任意字符</span></span><br></pre></td></tr></table></figure>
<p>location优先级: (location =) &gt; (location ^~ 路径) &gt; (location <del>,</del>* 正则顺序) &gt; (location 部分起始路径) &gt; (/)</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">直接匹配网站根会加速Nginx访问处理:</span><br><span class="line"><span class="attribute">location</span> = / &#123;</span><br><span class="line">	..... :</span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line">	......:</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">静态资源配置:</span><br><span class="line"><span class="attribute">location</span><span class="regexp"> ^~</span> /static/ &#123;</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#或者</span></span><br><span class="line"><span class="attribute">location</span> <span class="regexp">~* \.(gif|jpg|jpeg|png|css|js|ico)$</span> &#123;</span><br><span class="line">	..... </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">多应用配置</span><br><span class="line"><span class="attribute">location</span> <span class="regexp">~* /app1</span> &#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">location</span> <span class="regexp">~* /app2</span> &#123;</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Nginx四层访问控制"><a href="#Nginx四层访问控制" class="headerlink" title="Nginx四层访问控制"></a>Nginx四层访问控制</h3><p>访问控制基于模块ngx_http_access_module实现，可以通过匹配客户端源IP地址进行限制。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> /about &#123;</span><br><span class="line">	<span class="attribute">alias</span> /data/nginx/html/pc;</span><br><span class="line">	<span class="attribute">index</span> index.html;</span><br><span class="line">	<span class="attribute">deny</span> <span class="number">192.168.1.1</span>;</span><br><span class="line">	<span class="attribute">allow</span> <span class="number">192.168.1.0</span>/<span class="number">24</span>; </span><br><span class="line">	<span class="attribute">allow</span> <span class="number">10.1.1.0</span>/<span class="number">16</span>;</span><br><span class="line">	<span class="attribute">allow</span> <span class="number">2001</span>:0db8::/<span class="number">32</span>;</span><br><span class="line">	<span class="attribute">deny</span> all; <span class="comment">#先允许小部分， 再拒绝大部分</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Nginx账户认证功能"><a href="#Nginx账户认证功能" class="headerlink" title="Nginx账户认证功能"></a>Nginx账户认证功能</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@s2 ~]<span class="comment"># yum install httpd-tools -y #Centos</span></span><br><span class="line">[root@s2 ~]<span class="comment"># apt install apache2-utils #Ubuntu</span></span><br><span class="line">[root@s2 ~]<span class="comment"># htpasswd -cbm /apps/nginx/conf/ .htpasswd user1 123456</span></span><br><span class="line">Adding password <span class="keyword">for</span> user user1</span><br><span class="line">[root@s2 -]<span class="comment"># htpasswd -bm /apps/nginx/conf/ .htpasswd user2 123456</span></span><br><span class="line">Adding password <span class="keyword">for</span> user user2</span><br><span class="line">[root@s2 ~]<span class="comment"># tail /apps/nginx/conf/.htpasswd</span></span><br><span class="line">user1:<span class="variable">$apr</span><span class="variable">$SRjm0u2Kr</span><span class="variable">$VHvkAIc50Yg</span>.3ZoaGwaGq/</span><br><span class="line">user2:<span class="variable">$apr1</span><span class="variable">$nIqnxoJBSLR9W1DTJT</span>.viDJhXa6wHV.</span><br><span class="line">[root@s2 ~]<span class="comment"># vim /apps/nginx/conf/conf.d/pc.conf</span></span><br><span class="line">location = /login/ &#123;</span><br><span class="line">	root /data/nginx/html/pc;</span><br><span class="line">	index index.html;</span><br><span class="line">	auth_basic <span class="string">&quot;login password&quot;</span>;</span><br><span class="line">	auth_basic_user_file /apps/nginx/conf/.htpasswd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="自定义错误页面"><a href="#自定义错误页面" class="headerlink" title="自定义错误页面"></a>自定义错误页面</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line"><span class="attribute">server_name</span> www.kinmfer.com;</span><br><span class="line"><span class="attribute">error_page</span> <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span> <span class="number">404</span> /error.html;</span><br><span class="line"><span class="attribute">location</span> = /error.html &#123;</span><br><span class="line">	<span class="attribute">root</span> html;</span><br><span class="line">&#125;</span><br><span class="line">重启nginx并访问不存在的页面进行测试</span><br></pre></td></tr></table></figure>
<h3 id="自定义访问日志"><a href="#自定义访问日志" class="headerlink" title="自定义访问日志"></a>自定义访问日志</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@s2 -]# mkdir /data/nginx/logs</span><br><span class="line"><span class="attribute">listen</span> <span class="number">80</span>; </span><br><span class="line"><span class="attribute">server_name</span> www.kinmfer.com;</span><br><span class="line"><span class="attribute">error_page</span> <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span> <span class="number">404</span> /error.html; <span class="comment">#默认目录下面创建error.html页面</span></span><br><span class="line"><span class="attribute">access_log</span> /data/nginx/logs/www-kinmfer-com-access.log;</span><br><span class="line"><span class="attribute">error_log</span> /data/nginx/logs/www-kinmfer-com-<span class="literal">error</span>.log;</span><br><span class="line"><span class="attribute">location</span> = /error.html &#123;</span><br><span class="line">	<span class="attribute">root</span> html;</span><br><span class="line">&#125;</span><br><span class="line">也可以单独放在location中</span><br><span class="line"><span class="attribute">location</span> = /error.html &#123;</span><br><span class="line">	<span class="attribute">root</span> html;</span><br><span class="line">    <span class="attribute">access_log</span> /data/nginx/logs/www-kinmfer-com-access.log;</span><br><span class="line">	<span class="attribute">error_log</span> /data/nginx/logs/www-kinmfer-com-<span class="literal">error</span>.log;</span><br><span class="line">&#125;</span><br><span class="line">重启nginx并访问不存在的页面进行测试并验证是在指定目录生成新的日志文件</span><br></pre></td></tr></table></figure>
<h3 id="检测文件是否存在"><a href="#检测文件是否存在" class="headerlink" title="检测文件是否存在"></a>检测文件是否存在</h3><p>try_files会按顺序检查文件是否存在，返回第一个找到的文件或文件夹 (结尾加斜线表示为文件夹)，如果所有文件或文件夹都找不到，会进行一个内部重定向到最后一个参数。只有最后一个参数可以引起一个内部重定向，之前的参数只设置内部URI的指向。最后一个参数是回退URI且必须存在，否则会出现内部500错误。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">location /about &#123;</span><br><span class="line">	root /data/nginx/htm1/pc ;</span><br><span class="line">	<span class="comment">#alias /data/nginx/html/pc; </span></span><br><span class="line">	index index. html;</span><br><span class="line">	<span class="comment">#try_files $uri /about/default.html;</span></span><br><span class="line">	<span class="comment">#try_files $uri $uri/index.html $uri.html/about/default.html;</span></span><br><span class="line">	try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/index.html <span class="variable">$uri</span>.html =489;</span><br><span class="line">&#125;</span><br><span class="line">[root@s2 ~]<span class="comment"># echo &quot;default&quot;&gt;/data/nginx/html/pc/about/default .html</span></span><br><span class="line">重启nginx并测试，当访问到http://www.kinmfer.com/about/xx.html等不存在的uri会显示default,如果是自定义的状态码则会显示在返回数据的状态码中，如: </span><br><span class="line">[root@s2 about]<span class="comment"># curl --head http://www.kinmfer.com/about/xx.html</span></span><br><span class="line">HTTP/1.1 489 <span class="comment">#489就是自定义的状态返回码</span></span><br><span class="line">Server: nginx</span><br><span class="line">Date: Thu, 21 Feb 2019 00:11:40 GMT</span><br><span class="line">Content-Length: θ</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Keep-Alive: timeout=65</span><br></pre></td></tr></table></figure>
<h3 id="长连接配置"><a href="#长连接配置" class="headerlink" title="长连接配置"></a>长连接配置</h3><p>keepalive_timeout number; #设定保持连接超时时长，0表示禁止长连接，默认为75s, 通常配置在http字段作<br>为站点全局配置</p>
<p>keepalive_requests number; #在一次长连接上所允许请求的资源的最大数量，默认为100次</p>
<p>keepalive_disable none | browser …;#对哪种浏览器禁用长连接</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">keepalive_requests 200;</span><br><span class="line">keepalive_timeout 65 60;</span><br><span class="line">开启长连接后，返回客户端的会话保持时间为60s,单次长连接累计请求达到指定次数请求或65秒就会被断开，后面的</span><br><span class="line">60为发送给客户端应答报文头部中显示的超时时间设置为60s:如不设置客户端将不显示超时时间。</span><br><span class="line">Keep-Alive: timeout=60</span><br><span class="line"><span class="comment">#浏览器收到的服务器返回的报文</span></span><br><span class="line">如果设置为0表示关闭会话保持功能，将如下显示:</span><br><span class="line">Connection:close <span class="comment">#浏览器收到的服务器返回的报文</span></span><br><span class="line">使用命令测试:</span><br><span class="line">[root@s3 apps]<span class="comment"># telnet www.kinmer.com 80</span></span><br><span class="line">Trying 172.18.200.102...</span><br><span class="line">Connected to www.kinmfer.com.</span><br><span class="line">Escape character is <span class="string">&#x27;^]&#x27;</span>.</span><br><span class="line">GET / HTTP/1.1</span><br><span class="line">HOST: www. magedu. net</span><br><span class="line"><span class="comment">#Response Headers(响应头信息):</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.14.2</span><br><span class="line">Date: Thu, 14 Mar 2019 17:23:46 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 7</span><br><span class="line">Last-Modified: Thu, 14 Mar 2020 14:54:50 GMT</span><br><span class="line">Connection: keep- alive</span><br><span class="line">Keep-Alive: timeout=60</span><br><span class="line">ETag: <span class="string">&quot;5c8a6b3a-7&quot;</span></span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line"><span class="comment">#页面内容</span></span><br><span class="line">pc web</span><br></pre></td></tr></table></figure>
<h3 id="作为下载服务器"><a href="#作为下载服务器" class="headerlink" title="作为下载服务器"></a>作为下载服务器</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@s2 about]<span class="comment"># mkdir /data/nginx/html/pc/download</span></span><br><span class="line"><span class="comment">#download不需要index.html文件</span></span><br><span class="line">[root@s2 about]<span class="comment"># vim /apps/nginx/conf/conf.d/pc.conf</span></span><br><span class="line">location /download &#123;</span><br><span class="line">    root /data/nginx/htm1/pc;</span><br><span class="line">	autoindex on; <span class="comment">#自动索引功能</span></span><br><span class="line">	autoindex_exact_size on; <span class="comment">#计算文件确切大小(单位bytes) ，off只显示大概大小(单位kb、 mb、gb)</span></span><br><span class="line">	autoindex_localtime on; <span class="comment">#显示本机时间而非GMT(格林威治)时间</span></span><br><span class="line">    <span class="comment">#limit_rate 10k; ##限制响应给客户端的传输速率，单位是bytes/second, 默认值0表示无限制</span></span><br><span class="line">[root@s2 pc]<span class="comment"># cp /root/anaconda-ks.cfg /data/nginx/html/pc/download/</span></span><br><span class="line">重启Nginx并访问测试下载页面</span><br></pre></td></tr></table></figure>
<h3 id="作为上传服务器"><a href="#作为上传服务器" class="headerlink" title="作为上传服务器"></a>作为上传服务器</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">client_max_body_size</span> <span class="number">1m</span>; <span class="comment">#设置允许客户端上传单个文件的最大值，默认值为1m</span></span><br><span class="line"><span class="attribute">client_body_buffer_size</span> size;<span class="comment">#用于接收每个客户端请求报文的body部分的缓冲区大小;默认16k;超出此大小时，其将被暂存到磁盘上的由下面client_body_temp_path指令所定义的位置</span></span><br><span class="line"><span class="attribute">client_body_temp_path</span> path [level1 [level2 [1evel3]]];</span><br><span class="line"><span class="comment">#设定存储客户端请求报文的body部分的临时存储路径及子目录结构和数量，目录名为16进制的数字，使用hash之后的值从后往前截取1位、2位、2位作为文件名:</span></span><br><span class="line">[root@s3 ~]# md5sum /data/nginx/html/pc/index.html</span><br><span class="line">95f6f65f498c74938064851b1bb 96 3d 4 /data/nginx/html/pc/index . html</span><br><span class="line">1级目录占1位16进制，即2^4=16个目录0-f</span><br><span class="line">2级目录占2位16进制，即2^8=256个目录00-ff</span><br><span class="line">3级目录占2位16进制，即28=256个目录00-ff</span><br><span class="line"></span><br><span class="line">配置示例:</span><br><span class="line"><span class="attribute">client_max_body_size</span> <span class="number">10m</span>;</span><br><span class="line"><span class="attribute">client_body_buffer_size</span> <span class="number">16k</span>;</span><br><span class="line"><span class="attribute">client_body_temp_path</span> /apps/nginx/temp <span class="number">1</span> <span class="number">2</span> <span class="number">2</span>; <span class="comment">#reload Nginx会自动创建temp目录</span></span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/Kinmfer/BlogImages/raw/master/img/image-20200523202125465.png" alt="image-20200523202125465"></p>
<h3 id="其他配置"><a href="#其他配置" class="headerlink" title="其他配置"></a>其他配置</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">limit_except method ... &#123; ... &#125;，仅用于location</span><br><span class="line">限制客户端使用除了指定的请求方法之外的其它方法</span><br><span class="line">method:GET, HEAD, POST, PUT, DELETE, MKCOL, COPY, MOVE, OPTIONS, PROPFIND,PROPPATCH，LOCK，UNLOCK，PATCH</span><br><span class="line">	<span class="attribute">limit_except</span> GET &#123;</span><br><span class="line">		<span class="attribute">allow</span> <span class="number">192.168.0.0</span>/<span class="number">24</span>;</span><br><span class="line">		<span class="attribute">allow</span> <span class="number">192.168.7.101</span>;</span><br><span class="line">		<span class="attribute">deny</span> all;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="comment">#除了GET和HEAD之外其它方法仅允许192.168.1.0/24网段主机使用</span></span><br><span class="line">[root@s2 about]# mkdir /data/nginx/html/pc/upload</span><br><span class="line">[root@s2 about]# echo &quot;upload&quot; &gt; /data/nginx/html/pc/upload/ index.html</span><br><span class="line">[root@s2 about]# vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="line"><span class="attribute">location</span> /upload &#123;</span><br><span class="line">	<span class="attribute">root</span> /data/kinmfer/pc;</span><br><span class="line">	<span class="attribute">index</span> index.html;</span><br><span class="line">	<span class="attribute">limit_except</span> GET &#123;</span><br><span class="line">		<span class="attribute">allow</span> <span class="number">172.18.200.101</span>;</span><br><span class="line">		<span class="attribute">deny</span> all;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">aio</span> <span class="literal">on</span>| <span class="literal">off</span> <span class="comment">#是否启用asynchronous file I/0(AIO)功能，需要编译开启</span></span><br><span class="line">linux <span class="number">2</span>.<span class="number">6</span>以上内核提供以下几个系统调用来支持aio:</span><br><span class="line"><span class="number">1</span>、SYS_io_setup:建立aio的context</span><br><span class="line"><span class="number">2</span>、SYS_io_submit: 提交I/O操作请求</span><br><span class="line"><span class="number">3</span>、SYS_i0_getevents:获取已完成的I/O事件</span><br><span class="line"><span class="number">4</span>、SYS_i0_cancel:取消I/O操作请求</span><br><span class="line"><span class="number">5</span>、SYS_i0_destroy: 毁销aio的context</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">directio</span> size | <span class="literal">off</span>; <span class="comment">#操作完全和aio相反， aio是读取文件而directio是写文件到磁盘，启用直接I/O,默认为关闭，当文件大于等于给定大小时，例如directio 4m,同步(直接) 写磁盘，而非写缓存。</span></span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">open_file_cache</span> <span class="literal">off</span>; <span class="comment">#是否缓存打开过的文件信息</span></span><br><span class="line"><span class="attribute">open_file_cache</span> max=N [inactive=time];</span><br><span class="line">nginx可以缓存以下三种信息:</span><br><span class="line">(1)文件元数据:文件的描述符、文件大小和最近一次的修改时间</span><br><span class="line">(2)打开的目录结构</span><br><span class="line">(3)没有找到的或者没有权限访问的文件的相关信息</span><br><span class="line">max=N:可缓存的缓存项上限数量;达到上限后会使用LRU(Least recently used, 最近最少使用)算法实现</span><br><span class="line">管理</span><br><span class="line">inactive=time:缓存项的非活动时长，在此处指定的时长内未被命中的或命中的次数少于open_file_cache_min_uses指令所指定的次数的缓存项即为非活动项，将被删除</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">open_file_cache_errors</span> <span class="literal">on</span> | <span class="literal">off</span>;</span><br><span class="line">是否缓存查找时发生错误的文件一类的信息</span><br><span class="line">默认值为off</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">open_file_cache_min_uses number ;指令的inactive参数指定的时长内，至少被命中此处指定的次数方可被归类为活动项默认值为1</span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">open_file_cache_valid</span> time;</span><br><span class="line">缓存项有效性的检查验证频率，默认值为60s</span><br><span class="line"><span class="attribute">open_file_cache</span> max=<span class="number">10000</span> inactive=<span class="number">60s</span>; <span class="comment">#最大缓存10000个文件， 非活动数据超时时长605</span></span><br><span class="line"><span class="attribute">open_file_cache_valid</span> <span class="number">60s</span>; <span class="comment">#每间隔60s检查一下缓存 数据有效性</span></span><br><span class="line"><span class="attribute">open_file_cache_min_uses</span> <span class="number">5</span>; <span class="comment">#60秒内至少被命中访问5次才被标记为活动数据</span></span><br><span class="line"><span class="attribute">open_file_cache_errors</span>  <span class="literal">on</span>; <span class="comment">#缓存错误信息</span></span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">server_tokens</span> <span class="literal">off</span>; <span class="comment">#隐藏Nginx server版本。</span></span><br></pre></td></tr></table></figure>
<h1 id="Nginx高级配置"><a href="#Nginx高级配置" class="headerlink" title="Nginx高级配置"></a>Nginx高级配置</h1><h2 id="Nginx状态页"><a href="#Nginx状态页" class="headerlink" title="Nginx状态页"></a>Nginx状态页</h2><p>在编译安装nginx的时候需要添加编译参数–with-http-stub-status-module,否则配置完成之后监测会是提示语法错误。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">配置示例: </span><br><span class="line"><span class="attribute">location</span> /nginx_status &#123;</span><br><span class="line">	stub_status;</span><br><span class="line">    <span class="attribute">access_log</span> <span class="literal">off</span>;</span><br><span class="line">	<span class="attribute">allow</span> <span class="number">192.168.0.0</span>/<span class="number">16</span>;</span><br><span class="line">	<span class="attribute">allow</span> <span class="number">127.0.0.1</span>;</span><br><span class="line">	<span class="attribute">deny</span> all;</span><br><span class="line">状态页用于输出nginx的基本状态信息:</span><br><span class="line">输出信息示例:</span><br><span class="line"><span class="attribute">Active</span> connections: <span class="number">291</span></span><br><span class="line">server accepts handled requests</span><br><span class="line"><span class="number">16630948</span> <span class="number">16630948</span> <span class="number">31070465</span></span><br><span class="line">上面三个数字分别对应accepts, handled, requests三个值</span><br><span class="line">Reading: <span class="number">6</span> Writing: <span class="number">179</span> waiting: <span class="number">106</span></span><br><span class="line">        </span><br><span class="line">Active connections: 当前处于活动状态的客户端连接数， 包括连接等待空闲连接数。</span><br><span class="line">accepts:统计总值，Nginx自启动后已经接受的客户端请求的总数。</span><br><span class="line">handled:统计总值，Nginx自启动后已经处理完成的客户端请求的总数，通常等于accepts,除非有因</span><br><span class="line">worker_connections限制等被拒绝的连接。</span><br><span class="line">requests:统计总值，Nginx自启动后客户端发来的总的请求数。</span><br><span class="line">Reading:当前状态，正在读取客户端请求报文首部的连接的连接数。</span><br><span class="line">Writing:当前状态，正在向客户端发送响应报文过程中的连接数。</span><br><span class="line">Waiting:当前状态，正在等待客户端发出请求的空闲连接数，开启keep-alive的情况下， 这个值等于active-</span><br><span class="line">(reading+writing),</span><br></pre></td></tr></table></figure>
<p>Nginx第三方模块</p>
<p>第三模块是对nginx的功能扩展，第三方模块需要在编译安装Nginx的时候使用参数–add-module=PATH指定路径添加，有的模块是由公司的开发人员针对业务需求定制开发的，有的模块是开源爱好者开发好之后上传到github进行开源的模块，nginx支持第三方模块需要从源码重新编译支持，比如开源的echo模块<a target="_blank" rel="noopener" href="https://github.com/openresty/echo-nginx-module">https://github.com/openresty/echo-nginx-module</a>:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">[root@s2 pc]# systemctl stop nginx</span><br><span class="line">[root@s2 pc]# vim /apps/nginx/conf/conf.d/pc.conf</span><br><span class="line"><span class="attribute">location</span> /main &#123;</span><br><span class="line">	<span class="attribute">index</span> index. html;</span><br><span class="line">	<span class="attribute">default_type</span> text/html;</span><br><span class="line">	<span class="attribute">echo</span> <span class="string">&quot;hello world, main--&gt;&quot;</span>;</span><br><span class="line">	<span class="attribute">echo_reset_timer</span> ;</span><br><span class="line">	<span class="attribute">echo_location</span> /sub1;</span><br><span class="line">	<span class="attribute">echo_location</span> /sub2;</span><br><span class="line">	<span class="attribute">echo</span> <span class="string">&quot;took <span class="variable">$echo_timer_elapsed</span> sec for total.&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">location</span> /sub1 &#123;</span><br><span class="line">	<span class="attribute">echo_sleep</span> <span class="number">1</span>;</span><br><span class="line">	<span class="attribute">echo</span> sub1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">location</span> /sub2 &#123;</span><br><span class="line">	<span class="attribute">echo_sleep</span> <span class="number">1</span>;</span><br><span class="line">	<span class="attribute">echo</span> sub2;</span><br><span class="line">&#125;</span><br><span class="line">[root@s2 pc]# /apps/nginx/sbin/nginx -t</span><br><span class="line">nginx: [emerg] unknown directive &quot;echo_reset_timer&quot; in</span><br><span class="line">/apps/nginx/conf/conf.d/pc.conf:86</span><br><span class="line">nginx: configuration file /apps/nginx/conf/nginx.conf test failed</span><br><span class="line"></span><br><span class="line"><span class="comment">#解决以上报错问题</span></span><br><span class="line">[root@s2 src]# yum install git -y</span><br><span class="line">[root@s2 src]# git clone https://github.com/openresty/echo-nginx-module.git</span><br><span class="line">[root@s2 src]# cd nginx-1.12.2/</span><br><span class="line">[root@s2 src]# ./configure \</span><br><span class="line">--prefix=/apps/nginx \</span><br><span class="line">--user-nginx --group=nginx \</span><br><span class="line">--with-http_ss1_module \</span><br><span class="line">--with-http_v2_module \</span><br><span class="line">--with-http_realip_module \</span><br><span class="line">--with-http_stub_status_module \</span><br><span class="line">--with-http_gzip_static_module \</span><br><span class="line">-with-pcre \</span><br><span class="line">-with-stream \</span><br><span class="line">--With-stream_ssl_module \</span><br><span class="line">--with-stream_realip_module \</span><br><span class="line">--with-http_perl_module \</span><br><span class="line">-- add-module=/usr/1ocal/src/echo-nginx-module</span><br><span class="line">[root@s2 src]# make &amp;&amp; make install</span><br><span class="line"><span class="comment">#确认语法检测通过</span></span><br><span class="line">[root@s2 pc]# /apps/nginx/sbin/nginx -t</span><br><span class="line">nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /apps/nginx/conf/nginx.conf test is successful</span><br><span class="line"><span class="comment">#重启nginx访问测试:</span></span><br><span class="line">[root@s2 pc]# systemctl restart nginx</span><br><span class="line">[root@s2 pc]# curl http://www.kinmfer.com/main</span><br><span class="line"><span class="attribute">hello</span> world, main--&gt;</span><br><span class="line">sub1</span><br><span class="line">sub2</span><br><span class="line">took <span class="number">2</span>.<span class="number">010</span> sec for total. </span><br></pre></td></tr></table></figure>
<h2 id="Nginx变量使用"><a href="#Nginx变量使用" class="headerlink" title="Nginx变量使用"></a>Nginx变量使用</h2><p>nginx的变量可以在配置文件中引用，作为功能判断或者日志等场景使用，变量可以分为内置变量和自定义变量，内置变量是由nginx模块自带，通过变量可以获取到众多的与客户端访问相关的值。</p>
<h3 id="内置变量"><a href="#内置变量" class="headerlink" title="内置变量"></a>内置变量</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$remote_addr</span>;</span><br><span class="line"><span class="comment">#存放了客户端的地址，注意是客户端的公网IP，也就是一家人访问一个网站，则会显示为路由器的公网IP。</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$args</span>;</span><br><span class="line"><span class="comment">#变量中存放了URL中的指令，例如http://www.kinmfer.com/main/index.do?id=20190221&amp;partner=search中的id=20190221&amp;partner=search</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$document_root</span>;</span><br><span class="line"><span class="comment">#保存了针对当前资源的请求的系统根目录，如/apps/nginx/html</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$document_uri</span>;</span><br><span class="line"><span class="comment">#保存了当前请求中不包含指令的URI,注意是不包含请求的指令，比如</span></span><br><span class="line">http://www.kinmfer.com/main/index.do?id=20190221&amp;partner-search会被定为/main/index.do</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$host</span>;</span><br><span class="line"><span class="comment">#存放了请求的host名称。</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$http_user_agent</span>;</span><br><span class="line"><span class="comment">#客户端浏览器的详细信息</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$http_cookie</span>; </span><br><span class="line"><span class="comment">#客户端的cookie信息</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">limit_rate 10240;</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$limit_rate</span>;</span><br><span class="line"><span class="comment">#如果nginx服务器使用limit_rate配置了显示网络速率，则会显示，如果没有设置，则显示0。</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$remote_port</span>;</span><br><span class="line"><span class="comment">#客户端请求Nginx服务器时随机打开的端口，这是每个客户端自己的端口。</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$remote_user</span>;</span><br><span class="line"><span class="comment">#已经经过Auth Basic Module验证的用户名。</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$request_body_file</span>;</span><br><span class="line"><span class="comment">#做反向代理时发给后端服务器的本地资源的名称。</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$request_method</span>;</span><br><span class="line"><span class="comment">#请求资源的方式，GET/PUT/DELETE等</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$request_filename</span>;</span><br><span class="line"><span class="comment">#当前请求的资源文件的路径名称，由root或alias指令 与URI请求生成的文件绝对路径，</span></span><br><span class="line"><span class="comment">#如/apps/nginx/html/main/index.html</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$request_uri</span>; </span><br><span class="line"><span class="comment">#包含请求参数的原始URI,不包含主机名，如: /main/index.do?id=20190221&amp;par tner=search</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$scheme</span>;</span><br><span class="line"><span class="comment">#请求的协议，如ftp, https, http等。</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$server_protocol</span>;</span><br><span class="line"><span class="comment">#保存了客户端请求资源使用的协议的版本，如HTTP/1.0, HTTP/1.1, HTTP/2.0等。</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$server_addr</span>;</span><br><span class="line"><span class="comment">#保存了服务器的IP地址。</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$server_name</span>;</span><br><span class="line"><span class="comment">#请求的服务器的主机名。</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$server_port</span>;</span><br><span class="line"><span class="comment">#请求的服务器的端口号。</span></span><br></pre></td></tr></table></figure>
<h3 id="自定义变量"><a href="#自定义变量" class="headerlink" title="自定义变量"></a>自定义变量</h3><p>假如需要自定义变量名称和值，使用指令set $variable value;,则方法如下:<br>Syntax: set ​$variable value;<br>Default: -<br>Context: server, location, if</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">set</span> <span class="variable">$name</span> kinmfer;</span><br><span class="line"><span class="attribute">echo</span> <span class="variable">$name</span>; </span><br><span class="line"><span class="attribute">set</span> <span class="variable">$my_port</span> <span class="variable">$server_port</span>;</span><br><span class="line"><span class="attribute">echo</span> <span class="variable">$my_port</span>;</span><br><span class="line"><span class="attribute">echo</span> <span class="string">&quot;<span class="variable">$server_name</span>:<span class="variable">$server_port</span>&quot;</span>;</span><br></pre></td></tr></table></figure>
<h2 id="Nginx自定义访问日志"><a href="#Nginx自定义访问日志" class="headerlink" title="Nginx自定义访问日志"></a>Nginx自定义访问日志</h2><p>访问日志是记录客户端即用户的具体请求内容信息，全局配置模块中的error_log是记录nginx服务器运行时的日志保存路径和记录日志的level, 因此有着本质的区别，而且Nginx的错误日志一般只有一个，但是访问日志可以在不同server中定义多个，定义一个日志需要使用access_log指定日志的保存路径，使用log _format指定日志的格式，格式中定义要保存的具体日志内容。</p>
<h3 id="自定义默认格式"><a href="#自定义默认格式" class="headerlink" title="自定义默认格式"></a>自定义默认格式</h3><p>如果是要保留日志的源格式，只是添加相应的日志内容，则配置如下:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">log_format</span> nginx_format1 <span class="string">&#x27;<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] &quot;<span class="variable">$request</span>&quot; &#x27;</span></span><br><span class="line"><span class="string">&#x27;<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> &quot;<span class="variable">$http_referer</span>&quot; &#x27;</span></span><br><span class="line"><span class="string">&quot;<span class="variable">$http_user_agent</span>&quot;</span> <span class="string">&quot;<span class="variable">$http_x_forwarded_for</span>&quot;</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#x27;</span><span class="variable">$server_name</span>:<span class="variable">$server_port</span><span class="string">&#x27;;</span></span><br><span class="line"><span class="string">access_log logs/access.log nginx_format1; </span></span><br><span class="line"><span class="string">#重启nginx并访问测试日志格式</span></span><br><span class="line"><span class="string">==&gt; /apps/nginx/logs/access.log &lt;==</span></span><br><span class="line"><span class="string">192.168.0.1.。[22/Feb/2019:08:44:14 +0800] &quot;GET /favicon.ico HTTP/1.1”404 162 &quot;。”</span></span><br><span class="line"><span class="string">&quot;Mozilla/5.0 (Windows NT 6.1; Win64; x64; rV:65.0) Gecko/2</span></span><br><span class="line"><span class="string">0100101 Firefox/65.0&quot; &quot;. &quot;www.kinmfer.com:80</span></span><br></pre></td></tr></table></figure>
<h3 id="自定义json格式日志"><a href="#自定义json格式日志" class="headerlink" title="自定义json格式日志"></a>自定义json格式日志</h3><p>Nginx的默认访问日志记录内容相对比较单一, 默认的格式也不方便后期做日志统计分析，生产环境中通常将<br>nginx日志转换为json日志，然后配合使用ELK做日志收集-统计-分析。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">log_format</span> access_json <span class="string">&#x27;&#123;&quot;<span class="variable">@timestamp</span>&quot; :&quot;<span class="variable">$time</span> iso8601&quot;, &#x27;</span></span><br><span class="line"><span class="string">&#x27;&quot;host&quot;:&quot;<span class="variable">$server_addr</span>&quot;, &#x27;</span></span><br><span class="line"><span class="string">&#x27;&quot;clientip&quot;:&quot;<span class="variable">$remote_addr</span>&quot;, &#x27;</span></span><br><span class="line"><span class="string">&#x27;&quot;size&quot;:<span class="variable">$body_bytes_sent</span>,</span></span><br><span class="line"><span class="string">&#x27;</span><span class="string">&quot;responsetime&quot;</span>:<span class="variable">$request_time</span>, <span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#x27;</span><span class="string">&quot;upstreamtime&quot;</span> :<span class="string">&quot;<span class="variable">$upstream_response_time</span>&quot;</span>, <span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#x27;</span><span class="string">&quot;upstreamhost&quot;</span>: <span class="string">&quot;<span class="variable">$upstream_addr</span>&quot;</span>, <span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#x27;</span><span class="string">&quot;http_host&quot;</span>: <span class="string">&quot;<span class="variable">$host</span>&quot;</span>, <span class="string">&#x27; </span></span><br><span class="line"><span class="string">&#x27;</span><span class="string">&quot;uri&quot;</span>:<span class="string">&quot;<span class="variable">$uri</span>&quot;</span>,</span><br><span class="line"><span class="string">&#x27; domain&quot;: &quot;<span class="variable">$host</span>&quot;, &#x27;</span></span><br><span class="line"><span class="string">&#x27;&quot;xff&quot;:&quot;<span class="variable">$http_x_forwarded_for</span>&quot;, &#x27;</span></span><br><span class="line"><span class="string">&#x27;&quot;referer&quot;: &quot;<span class="variable">$http_referer</span>&quot;,</span></span><br><span class="line"><span class="string">&#x27;</span><span class="string">&quot;tcp_xff&quot;</span>: <span class="string">&quot;<span class="variable">$proxy_protocol_addr</span>&quot;</span>, <span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#x27;</span><span class="string">&quot;http_user_agent&quot;</span>: <span class="string">&quot;<span class="variable">$http_user_agent</span>&quot;</span>, <span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#x27;</span><span class="string">&quot;status&quot;</span>:<span class="string">&quot;<span class="variable">$status</span>&quot;</span>&#125;<span class="string">&#x27;;</span></span><br><span class="line"><span class="string">access_log /apps/nginx/1ogs/access_json.log access_json;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#重启Nginx并访问测试日志格式</span></span><br><span class="line"><span class="string">&#123;&quot;<span class="variable">@timestamp</span>&quot; :&quot;2019-02-22T08:55:32+08:00&quot;, &quot;host&quot;:&quot;192.168.7.102&quot;, &quot;clientip&quot;:&quot;192.168.0.1&quot;, &quot;size&quot; :162, &quot;responsetime&quot; :0.000, &quot;upstreamtime&quot;:&quot; -&quot;, &quot;upstreamhost&quot; :&quot;-&quot;, &quot;http_host&quot; : &quot;www.kinmfer.com&quot; , &quot;uri&quot;:&quot;/favicon.ico&quot; , &quot;domain&quot;: &quot;www.kinmfer.com&quot; , &quot;xff&quot;:&quot;-&quot;, &quot;referer&quot;:&quot;-&quot;,&quot;tcp_xff&quot;:&quot;&quot;, &quot;http_user_agent&quot; :&quot;Mozilla/5.0 (Windows NT 6.1; Win64;x64; rv:65.0) Gecko/20100101 Firefox/65&quot;, &quot;status&quot;:&quot;404&quot;&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="json格式的日志访问统计"><a href="#json格式的日志访问统计" class="headerlink" title="json格式的日志访问统计"></a>json格式的日志访问统计</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line">status_200= []</span><br><span class="line">status_404= []</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;access_ json.log&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">	<span class="keyword">for</span> line <span class="keyword">in</span> f.readlines():</span><br><span class="line">		line = <span class="built_in">eval</span>(line)</span><br><span class="line">		<span class="keyword">if</span> line.get(<span class="string">&quot;status&quot;</span>) == <span class="string">&quot;200&quot;</span>:</span><br><span class="line">			status_200.append(line.get)</span><br><span class="line">		<span class="keyword">elif</span> line.get(<span class="string">&quot;status&quot;</span>) == <span class="string">&quot;404&quot;</span>:</span><br><span class="line">			status_404.append(line.get)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			print(<span class="string">&quot;状态码ERROR&quot;</span> )</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;状态码200的有--:&quot;</span>, <span class="built_in">len</span>(status_200))</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;状态码404的有--:&quot;</span>, <span class="built_in">len</span>(status_404))</span><br><span class="line"><span class="comment">#保存日志文件到指定路径并进行测试:</span></span><br><span class="line">[root@s2 -]<span class="comment"># python nginx_json. py</span></span><br><span class="line">状态码<span class="number">200</span>的有--: <span class="number">1910</span></span><br><span class="line">状态码<span class="number">404</span>的有--: <span class="number">13</span></span><br></pre></td></tr></table></figure>
<h2 id="Nginx压缩功能"><a href="#Nginx压缩功能" class="headerlink" title="Nginx压缩功能"></a>Nginx压缩功能</h2><p>Nginx支持对指定类型的文件进行压缩然后再传输给客户端，而且压缩还可以设置压缩比例，压缩后的文件大小将比源文件显著变小，这样有助于降低出口带宽的利用率，降低企业的IT支出，不过会占用相应的CPU资源。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启用或禁用gzip压缩，默认关闭</span></span><br><span class="line">|gzip on | off;</span><br><span class="line"></span><br><span class="line"><span class="comment">#压缩比由低到高从1到9，默认为1</span></span><br><span class="line"><span class="attribute">gzip_comp_level</span> level;</span><br><span class="line"></span><br><span class="line"><span class="comment">#禁用IE6 gzip功能</span></span><br><span class="line"><span class="attribute">gzip_disable</span> <span class="string">&quot;MSIE [1-6]\.&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#gzip压缩的最小文件，小于设置值的文件将不会压缩</span></span><br><span class="line"><span class="attribute">gzip_min_length</span> <span class="number">1k</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#启用压缩功能时，协议的最小版本，默认HTTP/1.1</span></span><br><span class="line"><span class="attribute">gzip_http_version</span> <span class="number">1</span>.<span class="number">0</span> | <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#指定Nginx服务需要向服务器申请的缓存空间的个数*大小，默认32 4k|16 8k;</span></span><br><span class="line"><span class="attribute">gzip_buffers</span> number size;</span><br><span class="line"></span><br><span class="line"><span class="comment">#指明仅对哪些是型的资源执行压缩操作;默认为gzip_ .types text/html, 不用显示指定，否则出错</span></span><br><span class="line"><span class="attribute">gzip_types</span> mime-type ...:</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果启用压缩，是否在响应报文首部插入&quot;Vary: Accept - Encoding&quot;</span></span><br><span class="line">gzip_vary <span class="literal">on</span>| <span class="literal">off</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启nginx并进行访问测试压缩功能</span></span><br><span class="line">[root@s2 pc]# cp /apps/nginx/logs/access.log /data/nginx/html/pc/test.html</span><br><span class="line">[root@s2 pc]# echo &quot;test1&quot; &gt; /data/nginx/html/pc/test1.html #小于1k的文件测试是否会压缩</span><br><span class="line">[root@s2 pc]# vim /apps/nginx/conf/nginx.conf</span><br><span class="line"><span class="attribute">gzip</span> <span class="literal">on</span>; </span><br><span class="line"><span class="attribute">gzip_comp_level</span> <span class="number">3</span>;</span><br><span class="line"><span class="attribute">gzip_min_length</span> <span class="number">1k</span>;</span><br><span class="line"><span class="attribute">gzip_types</span> text/plain application/javascript application/x-javascript text/cssapplication/xml text/javascript application/x-httpd-php image/jpeg image/gif</span><br><span class="line">image/png;</span><br><span class="line"><span class="attribute">gzip_vary</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">重启Nginx并访问测试:</span><br><span class="line">[root@s2 pc]# curl --head --compressed http://www.kinmfer.com</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx</span><br><span class="line">Date: Thu, 21 Feb 2019 13:06:18 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 7</span><br><span class="line">Last-Modified: Tue, 19 Feb 2019 04:09:32 GMT</span><br><span class="line">Connection: keep- alive</span><br><span class="line">Keep-Alive: timeout=65</span><br><span class="line">ETag: &quot;5c6b817c-7&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line"></span><br><span class="line">[root@s2 -]# curl --head - -compressed http://www.kinmfer.com/test.html</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx</span><br><span class="line">Date: Fri, 22 Feb 2019 01:52:23 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Last-Modified: Thu, 21 Feb 2019 10:31:18 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Keep-Alive: timeout=65</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line">ETag: W/&quot;5c6e7df6-171109&quot;</span><br><span class="line">Content-Encoding: gzip #压缩传输</span><br></pre></td></tr></table></figure>
<h2 id="Https功能"><a href="#Https功能" class="headerlink" title="Https功能"></a>Https功能</h2><p>Web网站的登录页面都是使用https加密传输的，加密数据以保障数据的安全，HTTPS能够加密信息，以免敏感<br>信息被第三方获取，所以很多银行网站或电子邮箱等等安全级别较高的服务都会采用HTTPS协议，HTTPS其实是有两部分组成: HTTP+SSL/TLS, 也就是在HTTP上又加了一层处理加密信息的模块。服务端和客户端的信息传<br>输都会通过TLS进行加密，所以传输的数据都是加密后的数据。</p>
<p><img src="https://gitee.com/Kinmfer/BlogImages/raw/master/img/image-20200524093251561.png" alt="image-20200524093251561"></p>
<h3 id="ssl配置参数"><a href="#ssl配置参数" class="headerlink" title="ssl配置参数"></a>ssl配置参数</h3><p>nginx的https功能基于模块ngx_https_ssl_module实现，因此如果是编译安装的nginx要使用参数ngx_https_ssl_module开启ssI功能，但是作为nginx的核心功能，yum安装的nginx默认就是开启的，编译安装的nginx需要指定编译参数–with-https_ssl_module开启。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ssl</span> <span class="literal">on</span>| <span class="literal">off</span>;</span><br><span class="line"><span class="comment">#为指定的虚拟主机配置是否启用ssl功能，此功能在1.15.0废弃，使用listen [ssl]替代。</span></span><br><span class="line"><span class="attribute">ssl_certificate</span> /path/to/file;</span><br><span class="line"><span class="comment">#当前虚拟主机使用使用的公钥文件，一般是crt文件</span></span><br><span class="line"><span class="attribute">ssl_certificate_key</span> /path/to/file;</span><br><span class="line"><span class="comment">#当前虚拟主机使用的私钥文件，一般是key文件</span></span><br><span class="line"><span class="attribute">ssl_protocols</span> [SSLv2] [SSLv3] [TLSV1] [TLSV1.<span class="number">1</span>] [TLSV1.<span class="number">2</span>];</span><br><span class="line"><span class="comment">#支持ssl协议版本，早期为ssl, 现在是TSL,默认为后三个</span></span><br><span class="line"><span class="attribute">ssl_session_cache</span> <span class="literal">off</span> | <span class="literal">none</span> | [builtin[:size]] [shared:name:size];</span><br><span class="line"><span class="comment">#配置ssl缓存</span></span><br><span class="line">	off:关闭缓存</span><br><span class="line">	none:通知客户端支持ssl session cache, 但实际不支持</span><br><span class="line">	builtin[:size]:使用openSSL内建缓存，为每worker进程私有</span><br><span class="line">	[shared:name:size]:在各worker之间使用一个共享的缓存，需要定义一个缓存名称和缓存空间大小，一兆可以存储4000个会话信息，多个虚拟主机可以使用相同的缓存名称。</span><br><span class="line"><span class="attribute">ssl_session_timeout</span> time;<span class="comment">#客户端连接可以复用ssl session cache中缓存的有效时长，默认5m</span></span><br></pre></td></tr></table></figure>
<p>签署证书请看此篇博客：</p>
<p><a href="https://kinmfer.github.io/2020/05/05/Linux%E5%9F%BA%E7%A1%80-14-%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/#CA%E5%92%8C%E7%94%B3%E8%AF%B7%E8%AF%81%E4%B9%A6">https://kinmfer.github.io/2020/05/05/Linux%E5%9F%BA%E7%A1%80-14-%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/#CA和申请证书</a></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line"><span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line"><span class="comment">#不能放在location中</span></span><br><span class="line"><span class="attribute">ssl_certificate</span> /apps/nginx/certs/www.kinmfer.com.crt; </span><br><span class="line"><span class="attribute">ssl_certificate_key</span> /apps/nginx/certs/www.kinmfer.com.key;</span><br><span class="line"><span class="attribute">ssl_session_cache</span> shared:sslcache:<span class="number">20m</span>;</span><br><span class="line"><span class="attribute">ssl_session_timeout</span> <span class="number">10m</span>;</span><br><span class="line"><span class="comment">#重启Nginx并访问验证</span></span><br></pre></td></tr></table></figure>
<h3 id="实现多域名https"><a href="#实现多域名https" class="headerlink" title="实现多域名https"></a>实现多域名https</h3><p>Nginx支持基于单个IP实现多域名的功能，并且还支持单IP多域名的基础之上实现HTTPS,其实是基于Nginx的SNI (Server Name Indication)功能实现，SNI是为了解决个Nginx服务器内使用一个IP绑定多个域名和证书的功能，其具体功能是客户端在连接到服务器建立SSL链接之前先发送要访问站点的域名(Hostname) ， 这样服务器再根据这个域名返回给客户端一个合适的证书。</p>
<p>步骤与以上类似</p>
<h2 id="关于favicon-ico"><a href="#关于favicon-ico" class="headerlink" title="关于favicon.ico"></a>关于favicon.ico</h2><p>favicon.ico文件是浏览器收藏网址时显示的图标，当客户端使用浏览器问页面时，浏览器会自己主动发起请求获取页面的favicon.ico文件，但是当浏览器请求的favicon.ico文件不存在时，服务器会记录404日志，而且浏览器也会显示404报错。</p>
<p>解决办法</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#一:服务器不记录访问日志:</span></span><br><span class="line"><span class="comment">#location = /favicon.ico &#123;</span></span><br><span class="line"><span class="comment">#	log_not_found off;</span></span><br><span class="line"><span class="comment">#	access_log off;</span></span><br><span class="line"><span class="comment">#&#125;</span></span><br><span class="line"><span class="comment">#二:将图标保存到指定目录访问:</span></span><br><span class="line"><span class="comment">#location ~ ^/favicon\.ico$</span></span><br><span class="line"><span class="attribute">location</span> = /favicon.ico &#123;</span><br><span class="line">	<span class="attribute">root</span> /data/nginx/html/pc/images;</span><br><span class="line">	<span class="attribute">expires</span> <span class="number">90d</span>; <span class="comment">#设置文件过期时间</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="安全选项"><a href="#安全选项" class="headerlink" title="安全选项"></a>安全选项</h2><h3 id="自定义Nginx版本号"><a href="#自定义Nginx版本号" class="headerlink" title="自定义Nginx版本号"></a>自定义Nginx版本号</h3><p>更改Nginx源码信息并重新编译Nginx</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim src/http/ngx_http_header_filter_module.c</span></span><br><span class="line">49 static u_char ngx_http_server_string[] = <span class="string">&quot;Server: kinmfer666&quot;</span> CRLF; <span class="comment">#定义响应报文中的server字段信息</span></span><br></pre></td></tr></table></figure>
<h3 id="升级OpenSSL版本"><a href="#升级OpenSSL版本" class="headerlink" title="升级OpenSSL版本"></a>升级OpenSSL版本</h3><p>心脏出血(英语: Heartbleed)，也简称为心血漏洞，是一个出现在加密程序库OpenSSL的安全漏洞，该程序库广泛用于实现互联网的传输层安全(TLS) 协议。它于2012年被引入了软件中，2014年4月首次向公众披露。只要使用的是存在缺陷的OpenSSL实例，无论是服务器还是客户端，都可能因此而受到攻击。此问题的原因是在实现TLS的心跳扩展时没有对输入进行适当验证(缺少边界检查)，因此漏洞的名称来源于”心跳”(heartbeat) 。该程序错误属于缓冲区过读，即可以读取的数据比应该允许读取的还多。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">准备OpenSSL源码包:</span><br><span class="line"><span class="comment"># pwd</span></span><br><span class="line">/usr/1ocal/src</span><br><span class="line"><span class="comment"># tar xvf openssl-1.1.1d</span></span><br><span class="line">编译安装Nginx并制定新版本OpenSSL路径:</span><br><span class="line"><span class="comment"># cd /usr/1ocal/src/nginx-1.16.1/</span></span><br><span class="line"><span class="comment">#./configure --prefix=/apps/nginx --user=nginx --group=nginx --with-http_ss1_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module --with-select_module --with-file-aio -- add-module=/usr/1ocal/src/echo-nginx-module --with-openssl=/usr/1ocal/src/openssl-1.1.1d</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br><span class="line">验证并启动Nginx: </span><br><span class="line"><span class="comment"># /apps/nginx/sbin/nginx -t</span></span><br><span class="line">nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /apps/nginx/conf/nginx.conf <span class="built_in">test</span> is successful</span><br><span class="line"><span class="comment"># /apps/nginx/sbin/nginx</span></span><br></pre></td></tr></table></figure>
<h2 id="rewrite-功能"><a href="#rewrite-功能" class="headerlink" title="rewrite 功能"></a>rewrite 功能</h2><p>通过正则表达式的匹配来改变URI，可以同时存在一个或多个指令，按照顺序依次对URI进行匹配，rewrite主要是针对用户请求的URL或者是URI做具体处理。</p>
<p>　用法：rewrite regex replacement [flag];</p>
<p>　(1) rewrite flag</p>
<p>　　利用nginx的rewrite的指令，可以实现url的重新跳转，rewrtie有四种不同的flag，分别是redirect(临时重定向)、permanent(永久重定向)、break和last。其中前两种是跳转型的flag，后两种是代理型，跳转型是指由客户端浏览器重新对新地址进行请求，代理型是在WEB服务器内部实现跳转的。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">redirect；         #临时重定向，重写完成后以临时重定向方式直接返回重写后生成的新URL给客户端，由客户端重新发起请求；使用相对路径,或者http://或https://开头，状态码：302</span><br><span class="line">permanent；        #重写完成后以永久重定向方式直接返回重写后生成的新URL给客户端，由客户端重新发起请求，状态码：301</span><br><span class="line">last；             #重写完成后停止对当前URI在当前location中后续的其它重写操作，而后对新的URL启动新一轮重写检查，不建议在location中使用</span><br><span class="line">break；            #重写完成后停止对当前URL在当前location中后续的其它重写操作，而后直接跳转至重写规则配置块之后的其它配置；结束循环，建议在location中使用</span><br></pre></td></tr></table></figure>
<p>　(2) 临时重定向与永久重定向</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line">    <span class="attribute">root</span> /usr/local/nginx/html/pc;</span><br><span class="line">    <span class="attribute">index</span> index.html;</span><br><span class="line">    <span class="attribute">rewrite</span> / http://www.aaa.com <span class="literal">permanent</span>;</span><br><span class="line">    <span class="comment">#rewrite / http://www.aaa.com redirect;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　(3) last与break</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> /break &#123;</span><br><span class="line">    <span class="attribute">rewrite</span><span class="regexp"> ^/break/(.*)</span> /test<span class="variable">$1</span> <span class="literal">break</span>;        <span class="comment">#break不会跳转到其他的location</span></span><br><span class="line">    <span class="attribute">return</span> <span class="number">666</span> <span class="string">&quot;break&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span> /last &#123;</span><br><span class="line">    <span class="attribute">rewrite</span><span class="regexp"> ^/last/(.*)</span> /test<span class="variable">$1</span> <span class="literal">last</span>;     　　 <span class="comment">#last会跳转到其他的location继续匹配新的URI</span></span><br><span class="line">    <span class="attribute">return</span> <span class="number">888</span> <span class="string">&quot;last&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span> /test &#123;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">999</span> <span class="string">&quot;test&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　(4) 自动跳转https</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">ssl_certificate</span> /usr/local/nginx/certs/www.aaa.com.crt;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /usr/local/nginx/certs/www.aaa.com.key;</span><br><span class="line">    <span class="attribute">ssl_session_cache</span> shared:sslcache:<span class="number">20m</span>;</span><br><span class="line">    <span class="attribute">ssl_session_timeout</span> <span class="number">10m</span>;</span><br><span class="line">    <span class="attribute">server_name</span> www.aaa.com;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">root</span> html/aaa.com;</span><br><span class="line">        <span class="attribute">index</span> index.html index.htm;</span><br><span class="line">        <span class="attribute">if</span> (<span class="variable">$scheme</span> = http)&#123;    <span class="comment">#不加条件判断，会导致死循环</span></span><br><span class="line">            <span class="attribute">rewrite</span> / https://www.aaa.com <span class="literal">permanent</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#还一种是对监听的80端口进行跳转</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span> default_server;</span><br><span class="line">    <span class="attribute">server_name</span> www.aaa.com;</span><br><span class="line">    <span class="attribute">rewrite</span><span class="regexp"> ^(.*)$</span> https://<span class="variable">$server_name</span><span class="variable">$1</span> <span class="literal">permanent</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　(5) 判断文件是否存在</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">例：当用户访问到公司网站的时输入了一个错误的URL，可以将用户重定向至官网首页</span><br><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line">    <span class="attribute">root</span> /usr/local/nginx/html/pc;</span><br><span class="line">    <span class="attribute">index</span> index.html;</span><br><span class="line">    <span class="attribute">if</span> (!-f <span class="variable">$request_filename</span>) &#123;</span><br><span class="line">        <span class="comment">#return 404 &quot;No Page&quot;;</span></span><br><span class="line">        <span class="attribute">rewrite</span> (.*) http://www.aaa.net/index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　(6) 防盗链</p>
<p>　　防盗链基于客户端携带的referer实现，referer是记录打开一个页面之前记录是从哪个页面跳转过来的标记信息，如果别人只链接了自己网站图片或某个单独的资源，而不是打开了网站的整个页面，这就是盗链，referer就是之前的那个网站域名，正常的referer信息有以下几种：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">none：            　　#请求报文首部没有referer首部，比如用户直接在浏览器输入域名访问web网站，就没有referer信息。</span><br><span class="line">blocked：        　　 #请求报文有referer首部，但无有效值，比如为空。</span><br><span class="line">server_names：    　　#referer首部中包含本主机名及即nginx 监听的server_name。</span><br><span class="line">arbitrary_string：   #自定义指定字符串，可使用*作通配符。</span><br><span class="line">regular expression： #被指定的正则表达式模式匹配到的字符串,要使用~开头，例如：~.*\.aaa\.com</span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span><span class="regexp"> ^~</span> /images &#123;</span><br><span class="line">    <span class="attribute">root</span> /usr/local/nginx/pc;</span><br><span class="line">    <span class="attribute">index</span> index.html;</span><br><span class="line">    <span class="attribute">valid_referers</span> <span class="literal">none</span> <span class="literal">blocked</span> server_names <span class="regexp">*.aaa.com</span> <span class="regexp">www.aaa.*</span> api.online.test/v1/hostlist ~\.google\. ~\.baidu\.;                 <span class="comment">#定义有效的referer</span></span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$invalid_referer</span>) &#123;        <span class="comment">#假如是使用其他的无效的referer访问：</span></span><br><span class="line">        <span class="attribute">return</span> <span class="number">403</span>;             <span class="comment">#返回状态码403</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="代理功能"><a href="#代理功能" class="headerlink" title="代理功能"></a>代理功能</h2><p>Nginx除了可以在企业提供高性能的web服务之外，另外还可以将本身不具备的请求通过某种预定义的协议转发至其它服务器处理，不同的协议就是Nginx服务器与其他服务器进行通信的一种规范，主要在不同的场景使用以下模块实现不同的功能：</p>
<p>　　ngx_http_proxy_module： 　　将客户端的请求以http协议转发至指定服务器进行处理。<br>　　ngx_stream_proxy_module：　将客户端的请求以tcp协议转发至指定服务器处理。<br>　　ngx_http_fastcgi_module：　　将客户端对php的请求以fastcgi协议转发至指定服务器助理。<br>　　ngx_http_uwsgi_module：　　将客户端对Python的请求以uwsgi协议转发至指定服务器处理。</p>
<p>配置参数：<br>　　proxy_pass； #用来设置将客户端请求转发给的后端服务器的主机，可以是主机名、IP地址：端口的方式，也可以代理到预先设置的主机群组；</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> /web &#123;</span><br><span class="line">    <span class="attribute">index</span> index.html;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://192.168.7.103:80;</span><br><span class="line">    <span class="comment">#不带斜线将访问的/web，等于访问后端服务器 http://192.168.7.103:80/web/index.html，即后端服务器配置的站点根目录要有web目录才可以被访问，这是一个追加/web到后端服务器 http://servername:port/WEB/INDEX.HTML的操作</span></span><br><span class="line">    <span class="attribute">proxy_pass</span> http://192.168.7.103:80/;    <span class="comment">#带斜线，等于访问后端服务器的http://192.168.7.103:80/index.html 内容返回给客户端</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　(1) 正向代理配置</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#代理服务器上配置</span></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">resolver</span> <span class="number">8.8.8.8</span>;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">8088</span>;</span><br><span class="line">        <span class="attribute">location</span> / &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://<span class="variable">$http_host</span><span class="variable">$request_uri</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#客户端配置</span></span><br><span class="line"><span class="attribute">export</span> <span class="string">&quot;http_proxy=http://[user]:[pass]<span class="variable">@host</span>:port/&quot;</span></span><br><span class="line">如：export http_proxy=http://192.168.145.27:8088</span><br></pre></td></tr></table></figure>
<p>　(2) 反向代理配置</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> www.magedu.net;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://192.168.145.7:80/;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#也可以对指定location进行代理</span></span><br><span class="line"><span class="attribute">location</span> /web &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://192.168.7.103:80/;     <span class="comment">#注意有后面的/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　(3) 代理缓存功能</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#代理缓存功能默认关闭，可通过下面参数配置：</span></span><br><span class="line"><span class="attribute">proxy_cache</span> zone | <span class="literal">off</span>;         　　<span class="comment">#指明调用的缓存，或关闭缓存机制；默认off；Context:http, server, location</span></span><br><span class="line"><span class="attribute">proxy_cache_key</span> string;            <span class="comment">#缓存中用于&quot;键&quot;的内容，默认值：proxy_cache_key $scheme$proxy_host$request_uri;</span></span><br><span class="line"><span class="attribute">proxy_cache_valid</span> [code ...] time;    <span class="comment">#定义对特定响应码的响应内容的缓存时长，定义在http&#123;...&#125;中示例:</span></span><br><span class="line"><span class="attribute">proxy_cache_valid</span> <span class="number">200</span> <span class="number">302</span> <span class="number">10m</span>;</span><br><span class="line"><span class="attribute">proxy_cache_valid</span> <span class="number">404</span> <span class="number">1m</span>;</span><br><span class="line"></span><br><span class="line">proxy_cache_path;                #定义可用于proxy功能的缓存；Context:http</span><br><span class="line"><span class="attribute">proxy_cache_path</span> path [levels=levels] [use_temp_path=<span class="literal">on</span>|<span class="literal">off</span>]</span><br><span class="line">keys_zone=name:size [inactive=time] [max_size=size] [manager_files=number] [manager_sleep=time] [manager_threshold=time] [loader_files=number] [loader_sleep=time] [loader_threshold=time] [purger=<span class="literal">on</span>|<span class="literal">off</span>] [purger_files=number] [purger_sleep=time] [purger_threshold=time];</span><br><span class="line">例：在http配置定义缓存信息</span><br><span class="line"><span class="attribute">proxy_cache_path</span> /var/cache/nginx/proxy_cache        <span class="comment">#定义缓存保存路径，proxy_cache会自动创建</span></span><br><span class="line">levels=<span class="number">1</span>:<span class="number">2</span>:<span class="number">2</span>                <span class="comment">#定义缓存目录结构层次，1:2:2可以生成2^4x2^8x2^8=1048576个目录</span></span><br><span class="line">keys_zone=proxycache:<span class="number">20m</span>    <span class="comment">#指内存中缓存的大小，主要用于存放key和metadata（如：使用次数）</span></span><br><span class="line">inactive=<span class="number">120s</span>               <span class="comment">#缓存有效时间</span></span><br><span class="line">max_size=<span class="number">1g</span>;                <span class="comment">#最大磁盘占用空间，磁盘存入文件内容的缓存空间最大值</span></span><br><span class="line"><span class="comment">#调用缓存功能，需要定义在相应的配置段，如server&#123;...&#125;；或者location等</span></span><br><span class="line"><span class="attribute">proxy_cache</span> proxycache;</span><br><span class="line"><span class="attribute">proxy_cache_key</span> <span class="variable">$request_uri</span>;</span><br><span class="line"><span class="attribute">proxy_cache_valid</span> <span class="number">200</span> <span class="number">302</span> <span class="number">301</span> <span class="number">1h</span>;</span><br><span class="line"><span class="attribute">proxy_cache_valid</span> any <span class="number">1m</span>;</span><br><span class="line"></span><br><span class="line">proxy_cache_use_stale;　　　　#在被代理的后端服务器出现哪种情况下，可直接使用过期的缓存响应客户端</span><br><span class="line"><span class="attribute">proxy_cache_use_stale</span> <span class="literal">error</span> | timeout | invalid_header | updating | http_500 | http_502 | http_503 | http_504 | http_403 | http_404 | <span class="literal">off</span> ; 　　<span class="comment">#默认是off</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">proxy_cache_methods</span> GET | HEAD | POST ...;</span><br><span class="line"><span class="comment">#对哪些客户端请求方法对应的响应进行缓存，GET和HEAD方法总是被缓存</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">proxy_set_header</span> field value;</span><br><span class="line"><span class="comment">#设定发往后端主机的请求报文的请求首部的值</span></span><br><span class="line">Context: http, server, location</span><br><span class="line"><span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line"><span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">请求报文的标准格式如下：</span><br><span class="line">X-Forwarded-For: client1, proxy1, proxy2</span><br><span class="line"></span><br><span class="line">[root@www ~]# vim /usr/local/nginx/conf/nginx.conf</span><br><span class="line"><span class="comment">#配置在nginx.conf http配置段</span></span><br><span class="line"><span class="attribute">proxy_cache_path</span> /usr/local/nginx/proxycache levels=<span class="number">1</span>:<span class="number">1</span>:<span class="number">1</span> keys_zone=proxycache:<span class="number">20m</span> inactive=<span class="number">120s</span> max_size=<span class="number">1g</span>; </span><br><span class="line">[root@www ~]# vim /usr/local/nginx/conf/conf.d/pc.conf</span><br><span class="line"><span class="comment">#要缓存的URL 或者放在server配置项对所有URL都进行缓存</span></span><br><span class="line"><span class="attribute">location</span> /web &#123;     </span><br><span class="line">    <span class="attribute">proxy_pass</span> http://192.168.27.7:80/;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> clientip <span class="variable">$remote_addr</span>;</span><br><span class="line">    <span class="attribute">proxy_cache</span> proxycache;</span><br><span class="line">    <span class="attribute">proxy_cache_key</span> <span class="variable">$request_uri</span>;</span><br><span class="line">    <span class="attribute">proxy_cache_valid</span> <span class="number">200</span> <span class="number">302</span> <span class="number">301</span> <span class="number">1h</span>;</span><br><span class="line">    <span class="attribute">proxy_cache_valid</span> any <span class="number">1m</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　(4) 添加头部报文信息</p>
<p>　　Syntax: add_header name value [always];<br>　　Default: —<br>　　Context: http, server, location, if in location</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#添加自定义首部</span></span><br><span class="line"><span class="attribute">add_header</span> name value [always];</span><br><span class="line"><span class="attribute">add_header</span> X-Via <span class="variable">$server_addr</span>;</span><br><span class="line"><span class="attribute">add_header</span> X-Cache <span class="variable">$upstream_cache_status</span>;</span><br><span class="line"><span class="attribute">add_header</span> X-Accel <span class="variable">$server_name</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#添加自定义响应信息的尾部， 1.13.2版后支持</span></span><br><span class="line"><span class="attribute">add_trailer</span> name value [always];</span><br><span class="line"></span><br><span class="line"><span class="comment">#nginx配置：</span></span><br><span class="line"><span class="attribute">location</span> /web &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://192.168.27.7:80/;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> clientip <span class="variable">$remote_addr</span>;</span><br><span class="line">    <span class="attribute">proxy_cache</span> proxycache;</span><br><span class="line">    <span class="attribute">proxy_cache_key</span> <span class="variable">$request_uri</span>;</span><br><span class="line">    <span class="attribute">proxy_cache_valid</span> <span class="number">200</span> <span class="number">302</span> <span class="number">301</span> <span class="number">1h</span>;</span><br><span class="line">    <span class="attribute">proxy_cache_valid</span> any <span class="number">1m</span>;</span><br><span class="line">    <span class="attribute">add_header</span> X-Via <span class="variable">$server_addr</span>;</span><br><span class="line">    <span class="attribute">add_header</span> X-Cache <span class="variable">$upstream_cache_status</span>;</span><br><span class="line">    <span class="attribute">add_header</span> X-Accel <span class="variable">$server_name</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h2><p>(1) http的负载均衡-upstream</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">配置参数：</span><br><span class="line"><span class="attribute">upstream</span> name &#123;        <span class="comment">#自定义一组服务器，配置在http内</span></span><br><span class="line">    <span class="attribute">server</span> address [parameters];    <span class="comment">#配置一个后端web服务器，配置在upstream内，至少要有一个server服务器配置。</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#server支持的parameters如下：</span></span><br><span class="line">weight=number         #设置权重，默认为1</span><br><span class="line">max_conns=number      #给当前server设置最大活动链接数，默认为0表示没有限制</span><br><span class="line">max_fails=number      #对后端服务器连续监测失败多少次就标记为不可用</span><br><span class="line">fail_timeout=time     #对后端服务器的单次监测超时时间，默认为10秒</span><br><span class="line"><span class="attribute">backup</span>                <span class="comment">#设置为备份服务器，当所有服务器不可用时将重新启用次服务器</span></span><br><span class="line">down                  <span class="comment">#标记为down状态</span></span><br><span class="line">resolve               <span class="comment">#当server定义的是主机名的时候，当A记录发生变化会自动应用新IP而不用重启Nginx</span></span><br><span class="line"></span><br><span class="line">hash KEY consistent；</span><br><span class="line"><span class="comment">#基于指定key做hash计算，使用consistent参数，将使用ketama一致性hash算法，适用于后端是Cache服务器（如varnish）时使用，consistent定义使用一致性hash运算，一致性hash基于取模运算。所谓取模运算，就是计算两个数相除之后的余数，比如10%7=3, 7%4=3</span></span><br><span class="line">hash <span class="variable">$request_uri</span> consistent;     <span class="comment">#基于用户请求的uri做hash</span></span><br><span class="line">ip_hash；                         #源地址hash调度方法，基于的客户端的remote_addr(源地址)做hash计算，以实现会话保持</span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">调度算法：</span><br><span class="line">    rr：　　    　　 轮询，默认的调度方式，将所有请求都按照时间顺序分配到不同的服务上；</span><br><span class="line">    weight：    　　权重，指定每个服务的权重比例，weight和访问比率成正比；</span><br><span class="line">    ip_hash：  　　 指定负载均衡器按照基于客户端IP的分配方式，这个方法确保了相同的客户端的请求一直发送到相同的服务器，以保证session会话。这样每个访客都固定访问一个后端服务器，可以解决session不能跨服务器的问题；</span><br><span class="line">    least_conn：　　把请求转发给连接数较少的后端服务器。轮询算法是把请求平均的转发给各个后端，使它们的负载大致相同；但是，有些请求占用的时间很长，会导致其所在的后端负载较高。这种情况下，least_conn这种方式就可以达到更好的负载均衡效果</span><br><span class="line">    fair：　　　　　 按照服务器端的响应时间来分配请求，响应时间短的优先分配；</span><br><span class="line">    url_hash：　　　按访问url的hash结果来分配请求，使每个url定向到同一个后端服务器，要配合缓存命中来使用。同一个资源多次请求，可能会到达不同的服务器上，导致不必要的多次下载，缓存命中率不高，以及一些资源时间的浪费;　　　　　　　　　　　 而使用url_hash，可以使得同一个url（也就是同一个资源请求）会到达同一台服务器，一旦缓存住了资源，再此收到请求，就可以从缓存中读取；</span><br><span class="line">例：</span><br><span class="line"><span class="attribute">upstream</span> webserver &#123;</span><br><span class="line">    <span class="comment">#hash $request_uri consistent;</span></span><br><span class="line">    <span class="comment">#ip_hash；</span></span><br><span class="line">    <span class="comment">#least_conn;</span></span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.27.7:80</span> weight=<span class="number">1</span> fail_timeout=<span class="number">5s</span> max_fails=<span class="number">3</span>;             <span class="comment">#后端服务器状态监测</span></span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.27.17:80</span> weight=<span class="number">1</span> fail_timeout=<span class="number">5s</span> max_fails=<span class="number">3</span> backup;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> www.aaa.net;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">index</span> index.html index.php;</span><br><span class="line">        <span class="attribute">root</span> /usr/local/nginx/html/pc;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">location</span> /web &#123;</span><br><span class="line">        <span class="attribute">index</span> index.html;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://webserver/;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;     <span class="comment">#客户端IP透传，添加客户端IP到报文头部</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　(2) tcp的负载均衡</p>
<p>　　Nginx在1.9.0版本开始支持tcp模式的负载均衡，在1.9.13版本开始支持udp协议的负载，udp主要用于DNS的域名解析，其配置方式和指令和http代理类似，其基于ngx_stream_proxy_module模块实现tcp负载，另外基于模块ngx_stream_upstream_module实现后端。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">配置参数：</span><br><span class="line"><span class="section">stream</span> &#123;     　　　　<span class="comment">#定义stream</span></span><br><span class="line">    <span class="attribute">upstream</span> backend &#123;                        <span class="comment">#定义后端服务器</span></span><br><span class="line">        <span class="attribute">hash</span> <span class="variable">$remote_addr</span> consistent;         <span class="comment">#定义调度算法</span></span><br><span class="line">        <span class="attribute">server</span> backend1.example.com:<span class="number">12345</span> weight=<span class="number">5</span>;         <span class="comment">#定义具体server</span></span><br><span class="line">        <span class="attribute">server</span> <span class="number">127.0.0.1:12345</span> max_fails=<span class="number">3</span> fail_timeout=<span class="number">30s</span>;</span><br><span class="line">        <span class="attribute">server</span> unix:/tmp/backend3;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">upstream</span> dns &#123;                            <span class="comment">#定义后端服务器</span></span><br><span class="line">        <span class="attribute">server</span> <span class="number">192.168.0.1:53535</span>;             <span class="comment">#定义具体server</span></span><br><span class="line">        <span class="attribute">server</span> dns.example.com:<span class="number">53</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">server</span> &#123;                                  <span class="comment">#定义server</span></span><br><span class="line">        <span class="attribute">listen</span> <span class="number">12345</span>;                         <span class="comment">#监听IP:PORT</span></span><br><span class="line">        <span class="attribute">proxy_connect_timeout</span> <span class="number">1s</span>;             <span class="comment">#连接超时时间</span></span><br><span class="line">        <span class="attribute">proxy_timeout</span> <span class="number">3s</span>;                     <span class="comment">#转发超时时间</span></span><br><span class="line">        <span class="attribute">proxy_pass</span> backend;                   <span class="comment">#转发到具体服务器组</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">127.0.0.1:53</span> udp reuseport;</span><br><span class="line">        <span class="attribute">proxy_timeout</span> <span class="number">20s</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span> dns;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> [::<span class="number">1</span>]:<span class="number">12345</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span> unix:/tmp/stream.socket;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">实例1：Redis负载均衡</span><br><span class="line"><span class="section">stream</span> &#123;</span><br><span class="line">    <span class="attribute">upstream</span> redis_server &#123;</span><br><span class="line">        <span class="comment">#hash $remote_addr consistent;</span></span><br><span class="line">        <span class="attribute">server</span> <span class="number">192.168.145.27:6379</span> max_fails=<span class="number">3</span> fail_timeout=<span class="number">30s</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">192.168.145.7:6379</span>;</span><br><span class="line">        <span class="attribute">proxy_connect_timeout</span> <span class="number">3s</span>;</span><br><span class="line">        <span class="attribute">proxy_timeout</span> <span class="number">3s</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span> redis_server;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">实例2：mysql负载均衡</span><br><span class="line"><span class="section">stream</span> &#123;</span><br><span class="line">    <span class="attribute">upstream</span> mysql_server &#123;</span><br><span class="line">        least_conn;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">192.168.145.27:3306</span> max_fails=<span class="number">3</span> fail_timeout=<span class="number">30s</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">192.168.145.7:3306</span>;</span><br><span class="line">        <span class="attribute">proxy_connect_timeout</span> <span class="number">6s</span>;</span><br><span class="line">        <span class="attribute">proxy_timeout</span> <span class="number">15s</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span> mysql_server;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="FastCGI配置"><a href="#FastCGI配置" class="headerlink" title="FastCGI配置"></a>FastCGI配置</h2><p>Nginx基于模块ngx_http_fastcgi_module实现通过fastcgi协议将指定的客户端请求转发至php-fpm处理，其配置参数如下：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">fastcgi_pass</span> address;        <span class="comment">#转发请求到后端服务器，address为后端的fastcgi server的地址，可用位置：location, if in location </span></span><br><span class="line"><span class="attribute">fastcgi_index</span> name;            <span class="comment">#fastcgi默认的主页资源，示例：fastcgi_index index.php;</span></span><br><span class="line"><span class="attribute">fastcgi_param</span> parameter value [if_not_empty];        <span class="comment">#设置传递给FastCGI服务器的参数值，可以是文本，变量或组合，可用于将Nginx的内置变量赋值给自定义key</span></span><br><span class="line"><span class="attribute">fastcgi_param</span> REMOTE_ADDR <span class="variable">$remote_addr</span>;     <span class="comment">#客户端源IP</span></span><br><span class="line"><span class="attribute">fastcgi_param</span> REMOTE_PORT <span class="variable">$remote_port</span>;     <span class="comment">#客户端源端口</span></span><br><span class="line"><span class="attribute">fastcgi_param</span> SERVER_ADDR <span class="variable">$server_addr</span>;     <span class="comment">#请求的服务器IP地址</span></span><br><span class="line"><span class="attribute">fastcgi_param</span> SERVER_PORT <span class="variable">$server_port</span>;     <span class="comment">#请求的服务器端口</span></span><br><span class="line"><span class="attribute">fastcgi_param</span> SERVER_NAME <span class="variable">$server_name</span>;     <span class="comment">#请求的server name</span></span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Nginx默认配置示例：</span><br><span class="line"><span class="attribute">location</span> <span class="regexp">~ \.php$</span> &#123;</span><br><span class="line">    <span class="attribute">root</span> html;        <span class="comment">#$document_root 调用root目录</span></span><br><span class="line">    <span class="attribute">fastcgi_pass</span> <span class="number">127.0.0.1:9000</span>;</span><br><span class="line">    <span class="attribute">fastcgi_index</span> index.php;</span><br><span class="line">    <span class="attribute">fastcgi_param</span> SCRIPT_FILENAME /scripts<span class="variable">$fastcgi_script_name</span>;     <span class="comment">#默认脚本路径</span></span><br><span class="line">    <span class="comment">#fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;    #或用$document_root，</span></span><br><span class="line">    <span class="attribute">include</span> fastcgi_params;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">fastcgi缓存定义：</span><br><span class="line"><span class="attribute">fastcgi_cache_path</span> path [levels=levels] [use_temp_path=<span class="literal">on</span>|<span class="literal">off</span>] keys_zone=name:size [inactive=time] [max_size=size] [manager_files=number] [manager_sleep=time] [manager_threshold=time] [loader_files=number] [loader_sleep=time] [loader_threshold=time] [purger=<span class="literal">on</span>|<span class="literal">off</span>] [purger_files=number] [purger_sleep=time] [purger_threshold=time];</span><br><span class="line"><span class="attribute">path</span>                   <span class="comment">#缓存位置为磁盘上的文件系统路径</span></span><br><span class="line">max_size=size          <span class="comment">#磁盘path路径中用于缓存数据的缓存空间上限</span></span><br><span class="line">levels=levels：        <span class="comment">#缓存目录的层级数量，以及每一级的目录数量，levels=ONE:TWO:THREE，示例：leves=1:2:2</span></span><br><span class="line">keys_zone=name:size    <span class="comment">#设置缓存名称及k/v映射的内存空间的名称及大小</span></span><br><span class="line">inactive=time         <span class="comment">#缓存有效时间，默认10分钟，需要在指定时间满足fastcgi_cache_min_uses 次数被视为活动缓存</span></span><br><span class="line"></span><br><span class="line">fastcgi缓存调用：</span><br><span class="line">fastcgi_cache zone | <span class="literal">off</span>;        <span class="comment">#调用指定的缓存空间来缓存数据，可用位置：http, server, location</span></span><br><span class="line"><span class="attribute">fastcgi_cache_key</span> string;        <span class="comment">#定义用作缓存项的key的字符串，示例：fastcgi_cache_key $request_uri;</span></span><br><span class="line"><span class="attribute">fastcgi_cache_methods</span> GET | HEAD | POST ...;        <span class="comment">#为哪些请求方法使用缓存</span></span><br><span class="line"><span class="attribute">fastcgi_cache_min_uses</span> number;        <span class="comment">#缓存空间中的缓存项在inactive定义的非活动时间内至少要被访问到此处所指定的次数方可被认作活动项</span></span><br><span class="line"><span class="attribute">fastcgi_keep_conn</span> <span class="literal">on</span> | <span class="literal">off</span>;                <span class="comment">#收到后端服务器响应后，fastcgi服务器是否关闭连接，建议启用长连接</span></span><br><span class="line"><span class="attribute">fastcgi_cache_valid</span> [code ...] time;    <span class="comment">#不同的响应码各自的缓存时长</span></span><br><span class="line"><span class="attribute">fastcgi_hide_header</span> field;                 <span class="comment">#隐藏响应头指定信息</span></span><br><span class="line"><span class="attribute">fastcgi_pass_header</span> field;                 <span class="comment">#返回响应头指定信息，默认不会将Status、X-Accel-...返回</span></span><br></pre></td></tr></table></figure>
<p>Nginx与php-fpm实现：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">(1) 安装php-fpm</span><br><span class="line">[root@www ~]# yum install php-fpm php-mysql -y</span><br><span class="line">[root@www ~]# systemctl start php-fpm</span><br><span class="line">(2) 准备php测试页</span><br><span class="line">[root@www ~]# vim /usr/local/nginx/html/aaa.com/index.php</span><br><span class="line">&lt;?php</span><br><span class="line">    phpinfo();</span><br><span class="line">?&gt;</span><br><span class="line">(3) nginx配置转发</span><br><span class="line">[root@www ~]# vim /usr/local/nginx/conf/conf.d/aaa.conf</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> www.aaa.com;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">root</span> html/aaa.com;</span><br><span class="line">        <span class="attribute">index</span> index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~ \.php$</span> &#123;</span><br><span class="line">        <span class="attribute">root</span> html/aaa.com;</span><br><span class="line">        <span class="attribute">fastcgi_pass</span> <span class="number">127.0.0.1:9000</span>;</span><br><span class="line">        <span class="attribute">fastcgi_index</span> index.php;</span><br><span class="line">        <span class="attribute">fastcgi_param</span> SCRIPT_FILENAME <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">        <span class="attribute">include</span> fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">(3) 重启nginx并使用浏览器测试</span><br><span class="line">[root@www ~]# nginx -s reload</span><br><span class="line"></span><br><span class="line">php相关配置优化：</span><br><span class="line">[root@www ~]# grep &quot;^[a-Z]&quot; /etc/php-fpm.conf</span><br><span class="line">include=/etc/php-fpm.d/*.conf</span><br><span class="line"><span class="attribute">pid</span> = /run/php-fpm/php-fpm.pid</span><br><span class="line">error_log = /var/log/php-fpm/error.log</span><br><span class="line">daemonize = <span class="literal">yes</span>        <span class="comment">#是否后台启动</span></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@www</span> ~]<span class="comment"># grep &quot;^[a-Z]&quot; /etc/php-fpm.d/www.conf </span></span><br><span class="line">listen = <span class="number">127.0.0.1:9000</span>                    <span class="comment">#监听地址及IP</span></span><br><span class="line">listen.allowed_clients = <span class="number">127.0.0.1</span>        <span class="comment">#允许客户端从哪个源IP地址访问，要允许所有则在行首加 ; 注释即可</span></span><br><span class="line">user = nginx                            <span class="comment">#php-fpm启动的用户和组，会涉及到后期文件的权限问题</span></span><br><span class="line">group = nginx</span><br><span class="line">pm = dynamic                            <span class="comment">#动态模式进程管理</span></span><br><span class="line">pm.max_children = <span class="number">500</span>                    <span class="comment">#静态方式下开启的php-fpm进程数量，在动态方式下他限定php-fpm的最大进程数</span></span><br><span class="line">pm.start_servers = <span class="number">100</span>                    <span class="comment">#动态模式下初始进程数，必须大于等于pm.min_spare_servers和小于等于pm.max_children的值</span></span><br><span class="line">pm.min_spare_servers = <span class="number">100</span>                <span class="comment">#最小空闲进程数</span></span><br><span class="line">pm.max_spare_servers = <span class="number">200</span>                <span class="comment">#最大空闲进程数</span></span><br><span class="line">pm.max_requests = <span class="number">500000</span>                <span class="comment">#进程累计请求回收值，会重启</span></span><br><span class="line">pm.status_path = /pm_status             <span class="comment">#状态访问URL</span></span><br><span class="line">ping.path = /ping                         <span class="comment">#ping访问动地址</span></span><br><span class="line">ping.response = ping-pong                 <span class="comment">#ping返回值</span></span><br><span class="line">slowlog = /var/log/php-fpm/www-slow.log    <span class="comment">#慢日志路径</span></span><br><span class="line">php_admin_value[error_log] = /var/log/php-fpm/www-<span class="literal">error</span>.log        <span class="comment">#错误日志</span></span><br><span class="line">php_admin_flag[log_errors] = <span class="literal">on</span></span><br><span class="line">php_value[session.save_handler] = files                            <span class="comment">#phpsession保存方式及路径</span></span><br><span class="line">php_value[session.save_path] = /var/lib/php/session                <span class="comment">#当时使用file保存session的文件路径</span></span><br></pre></td></tr></table></figure>
<h1 id="系统参数优化"><a href="#系统参数优化" class="headerlink" title="系统参数优化"></a>系统参数优化</h1><p>默认的Linux内核参数考虑的是最通用场景，不符合用于支持高并发访问的Web服务器的定义，根据业务特点来进行调整，当Nginx作为静态web内容服务器、反向代理或者提供压缩服务器的服务器时，内核参数的调整都是不同的，此处针对最通用的、使Nginx支持更多并发请求的TCP网络参数做简单的配置，修改/etc/sysctl.conf来更改内核参数。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">fs.file-max = 1000000</span><br><span class="line"><span class="comment">#表示单个进程较大可以打开的句柄数</span></span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line"><span class="comment">#参数设置为 1 ，表示允许将TIME_WAIT状态的socket重新用于新的TCP链接，这对于服务器来说意义重大，因为总有大量TIME_WAIT状态的链接存在</span></span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_keepalive_time = 600</span><br><span class="line"><span class="comment">#当keepalive启动时，TCP发送keepalive消息的频度；默认是2小时，将其设置为10分钟，可更快的清理无效链接</span></span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_fin_timeout = 30</span><br><span class="line"><span class="comment">#当服务器主动关闭链接时，socket保持在FIN_WAIT_2状态的较大时间</span></span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 5000</span><br><span class="line"><span class="comment">#表示操作系统允许TIME_WAIT套接字数量的较大值，如超过此值，TIME_WAIT套接字将立刻被清除并打印警告信息,默认为8000，过多的TIME_WAIT套接字会使Web服务器变慢</span></span><br><span class="line"></span><br><span class="line">net.ipv4.ip_local_port_range = 1024 65000</span><br><span class="line"><span class="comment">#定义UDP和TCP链接的本地端口的取值范围</span></span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_rmem = 10240 87380 12582912</span><br><span class="line"><span class="comment">#定义了TCP接受缓存的最小值、默认值、较大值</span></span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_wmem = 10240 87380 12582912</span><br><span class="line"><span class="comment">#定义TCP发送缓存的最小值、默认值、较大值</span></span><br><span class="line"></span><br><span class="line">net.core.netdev_max_backlog = 8096</span><br><span class="line"><span class="comment">#当网卡接收数据包的速度大于内核处理速度时，会有一个列队保存这些数据包。这个参数表示该列队的较大值</span></span><br><span class="line"></span><br><span class="line">net.core.rmem_default = 6291456</span><br><span class="line"><span class="comment">#表示内核套接字接受缓存区默认大小</span></span><br><span class="line"></span><br><span class="line">net.core.wmem_default = 6291456</span><br><span class="line"><span class="comment">#表示内核套接字发送缓存区默认大小</span></span><br><span class="line"></span><br><span class="line">net.core.rmem_max = 12582912</span><br><span class="line"><span class="comment">#表示内核套接字接受缓存区较大大小</span></span><br><span class="line"></span><br><span class="line">net.core.wmem_max = 12582912</span><br><span class="line"><span class="comment">#表示内核套接字发送缓存区较大大小</span></span><br><span class="line"></span><br><span class="line">注意：以上的四个参数，需要根据业务逻辑和实际的硬件成本来综合考虑</span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line"><span class="comment">#与性能无关。用于解决TCP的SYN攻击</span></span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 8192</span><br><span class="line"><span class="comment">#这个参数表示TCP三次握手建立阶段接受SYN请求列队的较大长度，默认1024，将其设置的大一些可使出现Nginx繁忙来不及accept新连接时，Linux不至于丢失客户端发起的链接请求</span></span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_tw_recycle = 1</span><br><span class="line"><span class="comment">#这个参数用于设置启用timewait快速回收</span></span><br><span class="line"></span><br><span class="line">net.core.somaxconn=262114</span><br><span class="line"><span class="comment">#选项默认值是128，这个参数用于调节系统同时发起的TCP连接数，在高并发的请求中，默认的值可能会导致链接超时或者重传，因此需要结合高并发请求数来调节此值。</span></span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_max_orphans=262114</span><br><span class="line"><span class="comment">#选项用于设定系统中最多有多少个TCP套接字不被关联到任何一个用户文件句柄上。如果超过这个数字，孤立链接将立即被复位并输出警</span></span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:kinmfer@foxmail.com">Kinmfer</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://kinmfer.github.io/2020/05/26/%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84-Nginx-01-%E5%9F%BA%E7%A1%80/">https://kinmfer.github.io/2020/05/26/综合架构-Nginx-01-基础/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://Kinmfer.github.io" target="_blank">Kinmfer's Blogs</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%BD%91%E7%AB%99%E6%9C%8D%E5%8A%A1/">网站服务</a><a class="post-meta__tags" href="/tags/Nginx/">Nginx</a><a class="post-meta__tags" href="/tags/I-O%E6%A8%A1%E5%9E%8B/">I/O模型</a></div><div class="post_share"><div class="social-share" data-image="https://gitee.com/Kinmfer/BlogImages/raw/master/img/nginx.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/05/28/%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84-LVS/"><img class="prev-cover" src="https://gitee.com/Kinmfer/BlogImages/raw/master/img/均衡.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">负载均衡-LVS</div></div></a></div><div class="next-post pull-right"><a href="/2020/05/22/%E6%9D%82%E9%A1%B9/"><img class="next-cover" src="https://gitee.com/Kinmfer/BlogImages/raw/master/img/经验.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">杂项</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2020/05/22/综合架构-LAMP/" title="网站架构-LAMP"><img class="cover" src="https://gitee.com/Kinmfer/BlogImages/raw/master/img/apache.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-05-22</div><div class="title">网站架构-LAMP</div></div></a></div><div><a href="/2020/05/22/综合架构-Apache/" title="网站服务-Apache"><img class="cover" src="https://gitee.com/Kinmfer/BlogImages/raw/master/img/apache.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-05-22</div><div class="title">网站服务-Apache</div></div></a></div><div><a href="/2020/07/15/综合架构-Nginx-02-反向代理+负载均衡/" title="网站服务-Nginx-反向代理+负载均衡"><img class="cover" src="https://gitee.com/Kinmfer/BlogImages/raw/master/img/nginx.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-15</div><div class="title">网站服务-Nginx-反向代理+负载均衡</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div id="comment-switch"><span class="first-comment">Valine</span><span class="switch-btn"></span><span class="second-comment">Livere</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div><div><div id="lv-container" data-id="city" data-uid="MTAyMC81MTkzMi8yODQxMw=="></div></div></div></div></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" src="https://gitee.com/Kinmfer/BlogImages/raw/master/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Kinmfer</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">96</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">55</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">21</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Kinmfer"><i class="fab fa-github"></i><span>Github</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Kinmfer" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:kinmfer@foxmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">欢迎来到我的博客！本博客用于记录一些学习过程中的文章，包括原创，也包括转录其他大神的博客。</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E5%BD%B1%E5%93%8D"><span class="toc-number">1.</span> <span class="toc-text">性能影响</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E7%94%A8%E6%88%B7%E4%BD%93%E9%AA%8C%E7%9A%84%E5%87%A0%E4%B8%AA%E5%9B%A0%E7%B4%A0"><span class="toc-number">1.1.</span> <span class="toc-text">影响用户体验的几个因素</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AFI-O"><span class="toc-number">1.2.</span> <span class="toc-text">服务端I&#x2F;O</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#I-O%E6%A8%A1%E5%9E%8B"><span class="toc-number">2.</span> <span class="toc-text">I&#x2F;O模型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9FI-O"><span class="toc-number">2.1.</span> <span class="toc-text">系统I&#x2F;O</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5-%E5%BC%82%E6%AD%A5"><span class="toc-number">2.1.1.</span> <span class="toc-text">同步&#x2F;异步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%BB%E5%A1%9E-%E9%9D%9E%E9%98%BB%E5%A1%9E"><span class="toc-number">2.1.2.</span> <span class="toc-text">阻塞&#x2F;非阻塞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9FIO%E6%A8%A1%E5%9E%8B%E7%BB%84%E5%90%88"><span class="toc-number">2.1.3.</span> <span class="toc-text">系统IO模型组合</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E7%BB%9CI-O"><span class="toc-number">2.2.</span> <span class="toc-text">网络I&#x2F;O</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E9%98%BB%E5%A1%9E%E5%9E%8BI-O-blocking-IO"><span class="toc-number">2.2.1.</span> <span class="toc-text">同步阻塞型I&#x2F;O(blocking IO)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E9%9D%9E%E9%98%BB%E5%A1%9E%E5%9E%8BI-O-nonblocking-IO"><span class="toc-number">2.2.2.</span> <span class="toc-text">同步非阻塞型I&#x2F;O(nonblocking IO)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#I-O%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E5%9E%8B-IO-multiplexing"><span class="toc-number">2.2.3.</span> <span class="toc-text">I&#x2F;O多路复用型(IO multiplexing)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E9%A9%B1%E5%8A%A8%E5%BC%8FIO-signal-driven-IO"><span class="toc-number">2.2.4.</span> <span class="toc-text">信号驱动式IO(signal-driven IO)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E9%9D%9E%E9%98%BB%E5%A1%9EIO-asynchronous"><span class="toc-number">2.2.5.</span> <span class="toc-text">异步非阻塞IO(asynchronous)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IO%E5%AF%B9%E6%AF%94"><span class="toc-number">2.2.6.</span> <span class="toc-text">IO对比</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="toc-number">2.2.7.</span> <span class="toc-text">实现方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9E%8B%E6%B1%87%E6%80%BB"><span class="toc-number">2.2.8.</span> <span class="toc-text">常用模型汇总</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9E%8B%E9%80%9A%E7%9F%A5%E5%AF%B9%E6%AF%94"><span class="toc-number">2.2.9.</span> <span class="toc-text">常用模型通知对比</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MMAP%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.2.10.</span> <span class="toc-text">MMAP介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9F%E6%96%B9%E5%BC%8F%E6%8B%B7%E8%B4%9D%E6%95%B0%E6%8D%AE"><span class="toc-number">2.2.10.1.</span> <span class="toc-text">传统方式拷贝数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mmap%E6%96%B9%E5%BC%8F"><span class="toc-number">2.2.10.2.</span> <span class="toc-text">mmap方式</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx%E5%9F%BA%E7%A1%80"><span class="toc-number">3.</span> <span class="toc-text">Nginx基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.1.</span> <span class="toc-text">Nginx功能介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%89%B9%E6%80%A7"><span class="toc-number">3.1.1.</span> <span class="toc-text">基础特性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%92%8Cweb%E7%9B%B8%E5%85%B3%E7%9A%84%E5%8A%9F%E8%83%BD"><span class="toc-number">3.1.2.</span> <span class="toc-text">和web相关的功能</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E7%BB%84%E7%BB%87%E7%BB%93%E6%9E%84"><span class="toc-number">3.2.</span> <span class="toc-text">Nginx组织结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E7%BB%87%E6%A8%A1%E5%9E%8B"><span class="toc-number">3.2.1.</span> <span class="toc-text">组织模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1"><span class="toc-number">3.2.2.</span> <span class="toc-text">进程间通信</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.3.</span> <span class="toc-text">Nginx模块介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E5%AE%89%E8%A3%85"><span class="toc-number">3.4.</span> <span class="toc-text">Nginx安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx-yum%E5%AE%89%E8%A3%85"><span class="toc-number">3.4.1.</span> <span class="toc-text">Nginx yum安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85"><span class="toc-number">3.4.2.</span> <span class="toc-text">Nginx编译安装</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3"><span class="toc-number">4.</span> <span class="toc-text">Nginx核心配置详解</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">4.1.</span> <span class="toc-text">默认配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE"><span class="toc-number">4.2.</span> <span class="toc-text">全局配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#http%E8%AF%A6%E7%BB%86%E9%85%8D%E7%BD%AE"><span class="toc-number">4.3.</span> <span class="toc-text">http详细配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B"><span class="toc-number">4.4.</span> <span class="toc-text">核心配置示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#root%E5%92%8Calias"><span class="toc-number">4.4.1.</span> <span class="toc-text">root和alias</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#location%E7%9A%84%E8%AF%A6%E7%BB%86%E4%BD%BF%E7%94%A8"><span class="toc-number">4.4.2.</span> <span class="toc-text">location的详细使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E5%9B%9B%E5%B1%82%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6"><span class="toc-number">4.4.3.</span> <span class="toc-text">Nginx四层访问控制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E8%B4%A6%E6%88%B7%E8%AE%A4%E8%AF%81%E5%8A%9F%E8%83%BD"><span class="toc-number">4.4.4.</span> <span class="toc-text">Nginx账户认证功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%94%99%E8%AF%AF%E9%A1%B5%E9%9D%A2"><span class="toc-number">4.4.5.</span> <span class="toc-text">自定义错误页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AE%BF%E9%97%AE%E6%97%A5%E5%BF%97"><span class="toc-number">4.4.6.</span> <span class="toc-text">自定义访问日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%B5%8B%E6%96%87%E4%BB%B6%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8"><span class="toc-number">4.4.7.</span> <span class="toc-text">检测文件是否存在</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%95%BF%E8%BF%9E%E6%8E%A5%E9%85%8D%E7%BD%AE"><span class="toc-number">4.4.8.</span> <span class="toc-text">长连接配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%9C%E4%B8%BA%E4%B8%8B%E8%BD%BD%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">4.4.9.</span> <span class="toc-text">作为下载服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%9C%E4%B8%BA%E4%B8%8A%E4%BC%A0%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">4.4.10.</span> <span class="toc-text">作为上传服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E9%85%8D%E7%BD%AE"><span class="toc-number">4.4.11.</span> <span class="toc-text">其他配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE"><span class="toc-number">5.</span> <span class="toc-text">Nginx高级配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E7%8A%B6%E6%80%81%E9%A1%B5"><span class="toc-number">5.1.</span> <span class="toc-text">Nginx状态页</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E5%8F%98%E9%87%8F%E4%BD%BF%E7%94%A8"><span class="toc-number">5.2.</span> <span class="toc-text">Nginx变量使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E7%BD%AE%E5%8F%98%E9%87%8F"><span class="toc-number">5.2.1.</span> <span class="toc-text">内置变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F"><span class="toc-number">5.2.2.</span> <span class="toc-text">自定义变量</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AE%BF%E9%97%AE%E6%97%A5%E5%BF%97"><span class="toc-number">5.3.</span> <span class="toc-text">Nginx自定义访问日志</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%BB%98%E8%AE%A4%E6%A0%BC%E5%BC%8F"><span class="toc-number">5.3.1.</span> <span class="toc-text">自定义默认格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89json%E6%A0%BC%E5%BC%8F%E6%97%A5%E5%BF%97"><span class="toc-number">5.3.2.</span> <span class="toc-text">自定义json格式日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#json%E6%A0%BC%E5%BC%8F%E7%9A%84%E6%97%A5%E5%BF%97%E8%AE%BF%E9%97%AE%E7%BB%9F%E8%AE%A1"><span class="toc-number">5.3.3.</span> <span class="toc-text">json格式的日志访问统计</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E5%8E%8B%E7%BC%A9%E5%8A%9F%E8%83%BD"><span class="toc-number">5.4.</span> <span class="toc-text">Nginx压缩功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Https%E5%8A%9F%E8%83%BD"><span class="toc-number">5.5.</span> <span class="toc-text">Https功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ssl%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0"><span class="toc-number">5.5.1.</span> <span class="toc-text">ssl配置参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%A4%9A%E5%9F%9F%E5%90%8Dhttps"><span class="toc-number">5.5.2.</span> <span class="toc-text">实现多域名https</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E4%BA%8Efavicon-ico"><span class="toc-number">5.6.</span> <span class="toc-text">关于favicon.ico</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E9%80%89%E9%A1%B9"><span class="toc-number">5.7.</span> <span class="toc-text">安全选项</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89Nginx%E7%89%88%E6%9C%AC%E5%8F%B7"><span class="toc-number">5.7.1.</span> <span class="toc-text">自定义Nginx版本号</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%87%E7%BA%A7OpenSSL%E7%89%88%E6%9C%AC"><span class="toc-number">5.7.2.</span> <span class="toc-text">升级OpenSSL版本</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rewrite-%E5%8A%9F%E8%83%BD"><span class="toc-number">5.8.</span> <span class="toc-text">rewrite 功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%90%86%E5%8A%9F%E8%83%BD"><span class="toc-number">5.9.</span> <span class="toc-text">代理功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">5.10.</span> <span class="toc-text">负载均衡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FastCGI%E9%85%8D%E7%BD%AE"><span class="toc-number">5.11.</span> <span class="toc-text">FastCGI配置</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E5%8F%82%E6%95%B0%E4%BC%98%E5%8C%96"><span class="toc-number">6.</span> <span class="toc-text">系统参数优化</span></a></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/01/26/GOLANG-09-%E6%8C%87%E9%92%88/" title="GOLANG-09-指针"><img src="https://gitee.com/kinmfer/BlogImages/raw/master/img/GO.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="GOLANG-09-指针"/></a><div class="content"><a class="title" href="/2021/01/26/GOLANG-09-%E6%8C%87%E9%92%88/" title="GOLANG-09-指针">GOLANG-09-指针</a><time datetime="2021-01-26T12:39:45.000Z" title="发表于 2021-01-26 20:39:45">2021-01-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/01/26/%E4%BA%91%E8%AE%A1%E7%AE%97-Istio-Service-Mesh%E4%BB%8B%E7%BB%8D/" title="云计算-Istio-Service Mesh介绍"><img src="https://gitee.com/kinmfer/BlogImages/raw/master/img/istio-logo.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="云计算-Istio-Service Mesh介绍"/></a><div class="content"><a class="title" href="/2021/01/26/%E4%BA%91%E8%AE%A1%E7%AE%97-Istio-Service-Mesh%E4%BB%8B%E7%BB%8D/" title="云计算-Istio-Service Mesh介绍">云计算-Istio-Service Mesh介绍</a><time datetime="2021-01-26T08:16:47.000Z" title="发表于 2021-01-26 16:16:47">2021-01-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/01/26/%E4%BA%91%E8%AE%A1%E7%AE%97-Kubernetes-%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2-ingress/" title="Kubernetes-服务暴露-ingress"><img src="https://gitee.com/kinmfer/BlogImages/raw/master/img/k8s-logo.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Kubernetes-服务暴露-ingress"/></a><div class="content"><a class="title" href="/2021/01/26/%E4%BA%91%E8%AE%A1%E7%AE%97-Kubernetes-%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2-ingress/" title="Kubernetes-服务暴露-ingress">Kubernetes-服务暴露-ingress</a><time datetime="2021-01-26T02:43:56.000Z" title="发表于 2021-01-26 10:43:56">2021-01-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/01/26/%E4%BA%91%E8%AE%A1%E7%AE%97-Kubernetes-%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B/" title="Kubernetes-网络模型"><img src="https://gitee.com/kinmfer/BlogImages/raw/master/img/k8s-logo.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Kubernetes-网络模型"/></a><div class="content"><a class="title" href="/2021/01/26/%E4%BA%91%E8%AE%A1%E7%AE%97-Kubernetes-%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B/" title="Kubernetes-网络模型">Kubernetes-网络模型</a><time datetime="2021-01-26T02:43:45.000Z" title="发表于 2021-01-26 10:43:45">2021-01-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/01/26/%E4%BA%91%E8%AE%A1%E7%AE%97-Kubernetes-%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6/" title="Kubernetes-安全机制"><img src="https://gitee.com/kinmfer/BlogImages/raw/master/img/k8s-logo.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Kubernetes-安全机制"/></a><div class="content"><a class="title" href="/2021/01/26/%E4%BA%91%E8%AE%A1%E7%AE%97-Kubernetes-%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6/" title="Kubernetes-安全机制">Kubernetes-安全机制</a><time datetime="2021-01-26T02:38:31.000Z" title="发表于 2021-01-26 10:38:31">2021-01-26</time></div></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(https://gitee.com/Kinmfer/BlogImages/raw/master/img/nginx.png)"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2021 By Kinmfer</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://kinmfer.github.io/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="algolia-search"><div class="search-dialog"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>if (document.getElementsByClassName('mermaid').length) {
  if (window.mermaidJsLoad) mermaid.init()
  else {
    getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(() => {
      window.mermaidJsLoad = true
      mermaid.initialize({
        theme: 'default',
      })
      false && mermaid.init()
    })
  }
}</script><script>function loadValine () {
  function initValine () {
    let initData = {
      el: '#vcomment',
      appId: 'vSKb5nQqvUv44yjbvGjUmk3E-gzGzoHsz',
      appKey: '4TRbJGECRE8pcN777qgBXsKO',
      placeholder: '记得留下你的昵称和邮箱,可以快速收到回复哦~',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: {"tv_doge":"6ea59c827c414b4a2955fe79e0f6fd3dcd515e24.png","tv_����":"0d15c7e2ee58e935adc6a7193ee042388adc22af.png","tv_͵Ц":"bb690d4107620f1c15cff29509db529a73aee261.png","tv_�ټ�":"180129b8ea851044ce71caf55cc8ce44bd4a4fc8.png","tv_��Į":"b9cbc755c2b3ee43be07ca13de84e5b699a3f101.png","tv_��ŭ":"34ba3cd204d5b05fec70ce08fa9fa0dd612409ff.png","tv_�ɰ�":"9e55fd9b500ac4b96613539f1ce2f9499e314ed9.png","tv_��Ѫ":"09dd16a7aa59b77baa1155d47484409624470c77.png","tv_��":"241ee304e44c0af029adceb294399391e4737ef2.png","tv_Ż��":"9f996894a39e282ccf5e66856af49483f81870f3.png","tv_��Ц":"1f0b87f731a671079842116e0991c91c2c88645a.png","tv_���":"23269aeb35f99daee28dda129676f6e9ea87934f.png","tv_ί��":"d04dba7b5465779e9755d2ab6f0a897b9b33bb77.png","tv_΢Ц":"70dc5c7b56f93eb61bddba11e28fb1d18fddcd4c.png","tv_˼��":"90cf159733e558137ed20aa04d09964436f618a1.png"},
      enableQQ: false,
      path: window.location.pathname,
    }

    if (true) { 
      initData.requiredFields= ('nick,mail'.split(','))
    }
    
    if (false) {
      const otherData = false
      initData = Object.assign({}, initData, otherData)
    }
    
    const valine = new Valine(initData)
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.querySelector('#vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script>function loadLivere () {
  if (typeof LivereTower === 'object') {
    window.LivereTower.init()
  }
  else {
    (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
    })(document, 'script');
  }
}

if ('Valine' === 'Livere' || !false) {
  if (false) btf.loadComment(document.getElementById('lv-container'), loadLivere)
  else loadLivere()
}
else {
  function loadOtherComment () {
    loadLivere()
  }
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="//code.tidio.co/mzqu2o1lbhle9bvhab8bexgtiyxgkheb.js" async="async"></script><script>function onTidioChatApiReady() {
  window.tidioChatApi.hide();
  window.tidioChatApi.on("close", function() {
    window.tidioChatApi.hide();
  });
}
if (window.tidioChatApi) {
  window.tidioChatApi.on("ready", onTidioChatApiReady);
} else {
  document.addEventListener("tidioChat-ready", onTidioChatApiReady);
}

var chatBtnFn = () => {
  document.getElementById("chat_btn").addEventListener("click", function(){
    window.tidioChatApi.show();
    window.tidioChatApi.open();
  });
}
chatBtnFn()
</script></div></body></html>